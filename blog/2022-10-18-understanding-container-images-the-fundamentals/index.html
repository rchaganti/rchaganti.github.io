<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <script src="https://ravichaganti.com/js/view.js"></script>
    <script id="dsq-count-scr" src="//ravikanth.disqus.com/count.js" async></script>
    <link rel="stylesheet" href="https://ravichaganti.com/css/syntax.css">
    <meta name="author" content="Ravikanth Chaganti">
    <meta name="description" content="Containers have been around for a while. There is no need for an introduction to containers anymore but If you are still looking for some background, you can read a series of articles I have written on this blog. Docker simplified working with containers by introducing a way to package your applications and application dependencies as container images and provided the tooling that made it super easy to run container instances from these images.">
    <meta name="keywords" content="blog,microsoft,mvp,powershell,automation,author, innovator, speaker">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Understanding container images - The fundamentals"/>
<meta name="twitter:description" content="Containers have been around for a while. There is no need for an introduction to containers anymore but If you are still looking for some background, you can read a series of articles I have written on this blog. Docker simplified working with containers by introducing a way to package your applications and application dependencies as container images and provided the tooling that made it super easy to run container instances from these images."/>

    <meta property="og:title" content="Understanding container images - The fundamentals" />
<meta property="og:description" content="Containers have been around for a while. There is no need for an introduction to containers anymore but If you are still looking for some background, you can read a series of articles I have written on this blog. Docker simplified working with containers by introducing a way to package your applications and application dependencies as container images and provided the tooling that made it super easy to run container instances from these images." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ravichaganti.com/blog/2022-10-18-understanding-container-images-the-fundamentals/" />
<meta property="article:published_time" content="2022-10-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-18T00:00:00+00:00" />


    
      <base href="https://ravichaganti.com/blog/2022-10-18-understanding-container-images-the-fundamentals/">
    
    <title>
  Understanding container images - The fundamentals · Ravikanth Chaganti
</title>

    
      <link rel="canonical" href="https://ravichaganti.com/blog/2022-10-18-understanding-container-images-the-fundamentals/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://ravichaganti.com/css/coder.min.897f2f761ca1c7df1614de4c088e4ebbb7f5984b520994e5ee0a0fc4ba52f7de.css" integrity="sha256-iX8vdhyhx98WFN5MCI5Ou7f1mEtSCZTl7goPxLpS994=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://ravichaganti.com/css/coder-dark.min.e78e80fc3a585a4d1c8fc7f58623b6ff852411e38431a9cd1792877ecaa160f6.css" integrity="sha256-546A/DpYWk0cj8f1hiO2/4UkEeOEManNF5KHfsqhYPY=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="https://ravichaganti.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://ravichaganti.com/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.73.0" />
  </head>

  
  
    
  
  
    <body onload="getViews( &#34;https://ravichaganti.com/blog/2022-10-18-understanding-container-images-the-fundamentals/&#34; )" class="colorscheme-auto">
  
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://ravichaganti.com/">
      Ravikanth Chaganti
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://ravichaganti.com/about/">About</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://ravichaganti.com/blog/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://ravichaganti.com/books/">Books</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Understanding container images - The fundamentals</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2022-10-18T00:00:00Z'>
                October 18, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              18-minute read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://ravichaganti.com/categories/oci/">oci</a>
      <span class="separator">•</span>
    <a href="https://ravichaganti.com/categories/containers/">containers</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="https://ravichaganti.com/tags/oci/">oci</a>
      <span class="separator">•</span>
    <a href="https://ravichaganti.com/tags/containers/">containers</a></div>

        </div>
        <div class="post-meta">
          <span class="reading-time">
            <i class="fas fa-comments"></i>
            <a href="https://ravichaganti.com/blog/2022-10-18-understanding-container-images-the-fundamentals/#disqus_thread"> Comments</a>
          </span>
        </div>
        <div class="post-meta">
          <span class="reading-time">
            <i class="fas fa-eye"></i>
            <strong id="views"></strong>
            Readers
          </span>
        </div>        
      </header>
      <hr>
      <div>
        
        
        <p>Containers have been around for a while. There is no need for an introduction to containers anymore but If you are still looking for some background, you can read a <a href="http://localhost:1313/tags/containers/">series of articles</a> I have written on this blog. Docker simplified working with containers by introducing a way to package your applications and application dependencies as container images and provided the tooling that made it super easy to run container instances from these images. This meant the user space tools abstracted all complex details and removed the need to know the inner workings of containers. Like every other technology, knowing the internals of how something is built becomes important when troubleshooting issues or optimizing what the technology does. And, of course, knowing / learning internals is fun too!</p>
<p>Today&rsquo;s article is a collection of my notes [I made] as I started digging into how container images are built. First, the basics.</p>
<blockquote>
<p><strong>Note</strong>: This article uses Docker engine as an example. The fundamental concepts around how container images are managed do not change between different container engines.</p>
</blockquote>
<h3 id="the-basics">The basics</h3>
<p>Let us step back a bit and understand why there is a need for container images. Before containerization was made famous by Docker Inc., IT shops have used virtualization as a way to deploy multiple applications on single physical server. Virtualization vendors provided a set of tools to do this efficiently and sometimes in an automated manner. However, each virtual machine requires full operating system and application dependencies. Assuming that a single VM took ~10GB [very optimistic assumption] of space for OS alone, running 100 of them on a physical system will consume ~1TB. If all your VMs are running the same OS, this is a huge waste of disk space just to store duplicate files. You had to install application dependencies in each VM separately even when a majority of the applications have common dependencies. These limitations brought a bunch of operational challenges, such as patching / updates, portability, and distribution, as well.</p>
<p>Some virtualization vendors provided using differencing disks [for application code and dependencies] that shared a single parent disk containing an operating system. This, to some extent, helped but came with performance penalties and the same set of operational challenges.</p>
<p>When <a href="https://www.docker.com/press-release/dotcloud-inc-now-docker-inc/">dotCloud</a>, the company where Docker was born, started playing with Linux constructs to run applications as isolated processes [containers], they developed a method to package application code and dependencies in a way that did not result in the same challenges as virtual machines. This packaging made distribution of application code easy but solved the portability issues. What worked on a developer workstation worked in the production without a change. This packaging is what we call a container image. A container image is an immutable package of operating system files, application code, and any application dependencies. Container images consist of reusable layers that are stacked on top of each other. Before you dive into consuming or creating images, it is important to understand the Linux construct used in dealing with container images. It is called Union File System.</p>
<h4 id="union-file-system">Union File System</h4>
<p>The Union File System (<a href="https://unionfs.filesystems.org/">UnionFS</a>) in Linux allows merging contents of one or more file systems [directories] while keeping the content [physically] separate. There are different implementations such as AUFS and  OverlayFS that are meant for union mounts. Each of these different implementations have its pros and cons. To understand the concept of union file system, let us take OverlayFS as an example.</p>
<p>OverlayFS deals with layers of content &ndash; one or more lower layers and one upper layer. The lower layers are treated as read-only and the upper layer as read-write. OverlayFS provides a unified view of these layers through a union mount.</p>
<p>
<link rel="stylesheet" href="https://ravichaganti.com/css/hugo-easy-gallery.css" />
<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-1.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-1.png" itemprop="contentUrl"></a>
  </figure>
</div>
  



  


<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://ravichaganti.com/js/load-photoswipe.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>
</p>
<p>As you see in this depiction, the merged or the union view takes content from both lower and upper layers. If a file exists in both layers, such as file F3, the file in upper layer overrides the one in lower layer(s). Each file or directory operation has a specific result.</p>
<h4 id="adding-new-files">Adding new files</h4>
<p>When adding a new file, OverlayFS adds it to the upper layer.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-2.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-2.png" itemprop="contentUrl"></a>
  </figure>
</div>

<h4 id="deleting-an-existing-file">Deleting an existing file</h4>
<p>When you delete a file or folder from the upper layer, it gets, well, deleted. However, when you delete a file that is in the lower layer(s), a special character device gets created with the same name in the upper layer. The lower layers are read-only and therefore no files or folders get deleted from there. The character device in the upper layer indicates that the file or folder should be hidden from the unified view.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-3.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-3.png" itemprop="contentUrl"></a>
  </figure>
</div>

<h4 id="modify-an-existing-file">Modify an existing file</h4>
<p>There won&rsquo;t be any special change if you modify a file that exists in the upper layer. However, if you modify a file in the lower layer(s), the file first gets copied up to the upper layer, and then the changes are made to this copy.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-4.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-4.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Talk is cheap. Let us see this in action.</p>
<h4 id="overlayfs-in-action">OverlayFS in action</h4>
<p>Before creating a union mount, you must first prepare a few directories.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ mkdir lower upper merged work demo
$ <span class="nb">cd</span> demo
$ <span class="nb">echo</span> <span class="s2">&#34;This is a file 1 in lower layer&#34;</span> &gt; lower/f1
$ <span class="nb">echo</span> <span class="s2">&#34;This is a file 2 in lower layer&#34;</span> &gt; lower/f2
$ <span class="nb">echo</span> <span class="s2">&#34;This is a file 3 in lower layer&#34;</span> &gt; lower/f3
$ <span class="nb">echo</span> <span class="s2">&#34;This is a file 3 in upper layer&#34;</span> &gt; upper/f3
$ <span class="nb">echo</span> <span class="s2">&#34;This is a file 4 in upper layer&#34;</span> &gt; upper/f4
$ <span class="nb">cd</span> ..
$ tree demo/
demo/
├── lower
│   ├── f1
│   ├── f2
│   └── f3
├── merged
├── upper
│   ├── f3
│   └── f4
└── work
</code></pre></td></tr></table>
</div>
</div><p>Do not create any files in the merged or work directories. Merged will be the union mount where the unified view of lower and upper directories will be available. Now, you can use the <code>mount</code> command to perform a union mount.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo mount overlay -t overlay -o <span class="nv">lowerdir</span><span class="o">=</span>demo/lower/,upperdir<span class="o">=</span>demo/upper/,workdir<span class="o">=</span>demo/work/ demo/merged/
</code></pre></td></tr></table>
</div>
</div><p>The <code>mount</code> command above mounts the directories, <code>lowerdir</code> and <code>upperdir</code>, as a union mount under merged folder. The <code>workdir</code> can be considered a temporary scratch space copying files from lower to upper.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ ls -l demo/merged/
total <span class="m">16</span>
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f1
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f2
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f3
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f4

$ cat demo/merged/f3
This is a file <span class="m">3</span> in upper layer
</code></pre></td></tr></table>
</div>
</div><p>Once the mount command succeeds, you will see the contents of lower and upper directories merged to provide a unified view. You can now try different operations as depicted in the earlier images.</p>
<blockquote>
<p><strong>Note:</strong> When working with the union file system, you must make all changes in the unified mount. In the example, it is the merged directory.</p>
</blockquote>
<h5 id="adding-file">Adding file</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ <span class="nb">echo</span> <span class="s2">&#34;A new file called f5 in merged view&#34;</span> &gt;  demo/merged/f5

$ ls -l demo/merged/
total <span class="m">20</span>
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f1
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f2
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f3
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f4
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">36</span> Oct <span class="m">18</span> 13:34 f5

$ ls -l demo/upper/
total <span class="m">12</span>
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f3
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f4
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">36</span> Oct <span class="m">18</span> 13:34 f5
</code></pre></td></tr></table>
</div>
</div><p>Adding a file to the merged view adds it to the upper layer as that is the read/write layer.</p>
<h5 id="deleting-a-file">Deleting a file</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ rm demo/merged/f2

$ ls -l demo/merged/
total <span class="m">16</span>
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f1
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f3
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:31 f4
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">36</span> Oct <span class="m">18</span> 13:34 f5

$ ls -l demo/upper/
total <span class="m">12</span>
c--------- <span class="m">2</span> root      root      0, <span class="m">0</span> Oct <span class="m">18</span> 13:36 f2
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti   <span class="m">32</span> Oct <span class="m">18</span> 12:31 f3
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti   <span class="m">32</span> Oct <span class="m">18</span> 12:31 f4
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti   <span class="m">36</span> Oct <span class="m">18</span> 13:34 f5

$ ls -l demo/lower/
total <span class="m">12</span>
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f1
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f2
-rw-rw-r-- <span class="m">1</span> rchaganti rchaganti <span class="m">32</span> Oct <span class="m">18</span> 12:29 f3
</code></pre></td></tr></table>
</div>
</div><p>Deleting file f2 results in a special character file in upper layer. The lower layer, however, remains untouched.</p>
<h5 id="modify-file">Modify file</h5>
<p>When you modify a file, depending on where it is &ndash; upper or lower &ndash; a copy-up action takes place. For example, if you modify file f1 which exists in the lower layer, f1 first gets copied to the upper layer and gets modified in the upper layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ cat demo/merged/f1
This is a file <span class="m">1</span> in lower layer

$ <span class="nb">echo</span> <span class="s2">&#34;adding some random content&#34;</span> &gt;&gt; demo/merged/f1

$ cat demo/merged/f1
This is a file <span class="m">1</span> in lower layer
adding some random content

$ cat demo/upper/f1
This is a file <span class="m">1</span> in lower layer
adding some random content

$ cat demo/lower/f1
This is a file <span class="m">1</span> in lower layer
</code></pre></td></tr></table>
</div>
</div><p>As you see in the above example, file f1 in the lower layer is left untouched. A copy of f1 is present in the upper layer and gets modified to add the new line.</p>
<p>Now that you understand how OverlayFS works, it is time to see how container engines use union file system to manage container images.</p>
<h3 id="container-images">Container images</h3>
<p>Container engines like Docker support different types of storage drivers responsible for combining stacked layers into a single unified view. Similar to what you saw in the earlier example, each layer contains only the differences from the below layer. The immutable nature of these layers makes the container image reusable and allows you to run multiple containers from a single image. Each container gets its own thin writable layer to facilitate writing to the container file system or modifying or deleting existing files. The storage driver used by the container engine is responsible for managing the copy-on-write (CoW) layer. The Docker engine defaults to overlay2 as the storage driver.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/image-layers-containers.png" />
    </div>
    <a href="https://ravichaganti.com/images/image-layers-containers.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Let us dig into how this works. First, let us pull an image from the Docker hub for this exercise.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker pull ravikanth/hello-world:v1
v1: Pulling from ravikanth/hello-world
213ec9aee27d: Pull <span class="nb">complete</span>
0d351817f207: Pull <span class="nb">complete</span>
8b09275c3de5: Pull <span class="nb">complete</span>
Digest: sha256:9964e0545f1cbd09fc902dda80664ba4b23b5f4bd32b1a0e7ab135f819c5ed6c
Status: Downloaded newer image <span class="k">for</span> ravikanth/hello-world:v1
docker.io/ravikanth/hello-world:v1
</code></pre></td></tr></table>
</div>
</div><p>The image that we just pulled has three layers. The <code>overlay2</code> driver on the Docker host stores the image layers at <code>/var/lib/docker/overlay2</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2
total <span class="m">16</span>
drwx--x--- <span class="m">4</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696
drwx--x--- <span class="m">4</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39
drwx--x--- <span class="m">3</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22
drwx------ <span class="m">2</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 l
</code></pre></td></tr></table>
</div>
</div><p>The directories at this location are uncompressed image layers and therefore the ID does not match the layer ID in the image. The directory named <code>l</code> contains the symbolic links to the <code>diff</code> directory within each uncompressed layer.</p>
<p>If you have multiple other images on the docker host already, you can use <code>docker image inspect</code> command to find the right uncompressed layer IDs for a specific image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker image inspect ravikanth/hello-world:v1 <span class="p">|</span> jq -r <span class="s1">&#39;.[0] | {Data: .GraphDriver.Data}&#39;</span>
<span class="o">{</span>
  <span class="s2">&#34;Data&#34;</span>: <span class="o">{</span>
    <span class="s2">&#34;LowerDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff:/var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff&#34;</span>,
    <span class="s2">&#34;MergedDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/merged&#34;</span>,
    <span class="s2">&#34;UpperDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/diff&#34;</span>,
    <span class="s2">&#34;WorkDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/work&#34;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The property names &ndash; <code>LowerDir</code>, <code>UpperdDir</code>, <code>MergeDir</code>, and <code>WorkDir</code> &ndash; in the above output should be familiar by now. The layer IDs listed in the output will correlate to the <code>ls</code> output earlier. If you observe this output, the <code>LowerDir</code> property has more than one layer associated with it as the value.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">/var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff
/var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff
</code></pre></td></tr></table>
</div>
</div><p>These layers are represented in the order of their position in the container image. Therefore, <code>ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22</code> is the lowest layer and <code>d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39</code> is the layer above the lowest layer. From the image pull output, you see that there are three layers in this image. The layer represented by <code>UpperDir</code> is the topmost layer in this image.</p>
<p>Now that we know the order of the layers, let us move on to see what is there in each of these uncompressed layer directories.</p>
<p>The lowest layer contains three entries.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22
total <span class="m">8</span>
-rw-------  <span class="m">1</span> root root    <span class="m">0</span> Oct <span class="m">18</span> 15:32 committed
drwxr-xr-x <span class="m">19</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 diff
-rw-r--r--  <span class="m">1</span> root root   <span class="m">26</span> Oct <span class="m">18</span> 15:32 link

$ sudo ls -l /var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff
total <span class="m">68</span>
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 bin
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 dev
drwxr-xr-x <span class="m">16</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 etc
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 home
drwxr-xr-x  <span class="m">7</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 lib
drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 media
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 mnt
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 opt
dr-xr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 proc
drwx------  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 root
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 run
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 sbin
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 srv
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 sys
drwxrwxrwt  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 tmp
drwxr-xr-x  <span class="m">7</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 usr
drwxr-xr-x <span class="m">12</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 var

$ sudo cat /var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/link
BOOTVTCSKJUJXUJWX765MW7TMJ

$ sudo ls -l /var/lib/docker/overlay2/l/BOOTVTCSKJUJXUJWX765MW7TMJ
lrwxrwxrwx <span class="m">1</span> root root <span class="m">72</span> Oct <span class="m">18</span> 15:32 /var/lib/docker/overlay2/l/BOOTVTCSKJUJXUJWX765MW7TMJ -&gt; ../ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff
</code></pre></td></tr></table>
</div>
</div><p>This image is based on <code>alpine:latest</code> and therefore <code>diff</code> directory in the lowest layer contains the OS files. Let us move to the next layer. If you look at the last command in the output, file named<code>link</code> in the uncompressed layer is referencing the <code>diff</code> directory in the same layer.</p>
<p>Let us move to the next layer in the stack.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39
total <span class="m">16</span>
-rw------- <span class="m">1</span> root root    <span class="m">0</span> Oct <span class="m">18</span> 15:32 committed
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 diff
-rw-r--r-- <span class="m">1</span> root root   <span class="m">26</span> Oct <span class="m">18</span> 15:32 link
-rw-r--r-- <span class="m">1</span> root root   <span class="m">28</span> Oct <span class="m">18</span> 15:32 lower
drwx------ <span class="m">3</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 work

$ sudo ls -l /var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff
total <span class="m">0</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">0</span> Oct <span class="m">16</span> 10:54 hello.txt

$ sudo cat /var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff/hello.txt

$ sudo cat /var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/link
FYTORA5MEBUHE4B4ZY4IPI3P5D

$ sudo cat /var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/lower
l/BOOTVTCSKJUJXUJWX765MW7TMJ
</code></pre></td></tr></table>
</div>
</div><p>All uncompressed layers above the lowest layer contain five entries. The <code>diff</code> directory contains the contents of the layer &ndash; a zero-byte hello.txt file in this case. The file named lower points to the lower layer in the stack. And, in this example, it naturally points to the lower layer <code>diff</code> directory. You can ignore the rest of the entries in this uncompressed layer. In each layer, the <code>link</code> file contains the symbolic link to the layer&rsquo;s <code>diff</code> directory.</p>
<p>Finally, we have one more layer to look at.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696
total <span class="m">16</span>
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 diff
-rw-r--r-- <span class="m">1</span> root root   <span class="m">26</span> Oct <span class="m">18</span> 15:32 link
-rw-r--r-- <span class="m">1</span> root root   <span class="m">57</span> Oct <span class="m">18</span> 15:32 lower
drwx------ <span class="m">3</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 15:32 work

$ sudo ls -l /var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/diff
total <span class="m">4</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">35</span> Oct <span class="m">16</span> 10:54 hello.txt

$ sudo cat /var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/diff/hello.txt
this is an update to the hello.txt

$ sudo cat /var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/link
S2YWWPZHW75GE3EIQ7ULNMR5RZ

$ sudo cat /var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/lower
l/FYTORA5MEBUHE4B4ZY4IPI3P5D:l/BOOTVTCSKJUJXUJWX765MW7TMJ
</code></pre></td></tr></table>
</div>
</div><p>This layer has two layers below it and therefore you see two entries (separated by :) in the file named <code>lower</code>. Similar to the previous layer, the <code>diff</code> directory in the layer contains a file named hello.txt. As this is the upper layer or the topmost layer, when a container is created using this image, you should see the contents of this hello.txt file within the container.</p>
<p>To better understand this, you need to visualize this layer structure.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-layers-1.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-layers-1.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>As described earlier, container images are immutable. You cannot write anything directly to these layers. The only way to consume these layers is to create a container instance. You can do that using the <code>docker run</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker run -d --name helloworld ravikanth/hello-world:v1 sleep <span class="m">1000000</span>
cff3f0322cb6765f06575bba9405d8ffeb0fecac237c5f615b906a9546d2a413
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Note</strong>: Starting this container in the background will help in exploring the copy-on-write operations.</p>
</blockquote>
<p>In an earlier illustration, you saw how more than one container can be created from a single image and how each gets its own copy-on-write (CoW) read/write layer. So, in theory, this CoW layer must be somehow getting associated with the uncompressed image layers that you explored. This association can be found by running the docker container inspect command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker container inspect helloworld <span class="p">|</span> jq -r <span class="s1">&#39;.[0] | {Data: .GraphDriver.Data}&#39;</span>
<span class="o">{</span>
  <span class="s2">&#34;Data&#34;</span>: <span class="o">{</span>
    <span class="s2">&#34;LowerDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751-init/diff:/var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/diff:/var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff:/var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff&#34;</span>,
    <span class="s2">&#34;MergedDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/merged&#34;</span>,
    <span class="s2">&#34;UpperDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/diff&#34;</span>,
    <span class="s2">&#34;WorkDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/work&#34;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>This looks similar to what you have seen in the image information. The <code>LowerDir</code> has four different layers in the below order.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751-init/diff
/var/lib/docker/overlay2/cf0b92185c9ba3bdf11d19e53252063def37acf80fe3491597fd5a8914e1a696/diff
/var/lib/docker/overlay2/d63b70e8f22063b1eb4296b70c2e231392e28b104475104e14f7346530e0dd39/diff
/var/lib/docker/overlay2/ec861e1affe1b78197b7cc7f6f4381c6de0e490e04a60dc1ff684a9f7ddeab22/diff
</code></pre></td></tr></table>
</div>
</div><p>This is essentially the three image layers you saw earlier and an additional container layer. You may have observed <code>MergeDir</code> and <code>WorkDir</code> in the image information output. However, as images are immutable, these values do not matter much for an image. In the case of a container, these values do matter. Therefore, the <code>/var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/merged</code> directory contains the unified view of all image layers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/merged
total <span class="m">72</span>
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 bin
drwxr-xr-x  <span class="m">1</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 18:10 dev
drwxr-xr-x  <span class="m">1</span> root root <span class="m">4096</span> Oct <span class="m">18</span> 18:10 etc
-rw-r--r--  <span class="m">1</span> root root   <span class="m">35</span> Oct <span class="m">16</span> 10:54 hello.txt
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 home
drwxr-xr-x  <span class="m">7</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 lib
drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 media
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 mnt
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 opt
dr-xr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 proc
drwx------  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 root
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 run
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 sbin
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 srv
drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 sys
drwxrwxrwt  <span class="m">2</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 tmp
drwxr-xr-x  <span class="m">7</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 usr
drwxr-xr-x <span class="m">12</span> root root <span class="m">4096</span> Aug  <span class="m">9</span> 14:17 var

$ sudo cat /var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/merged/hello.txt
this is an update to the hello.txt
</code></pre></td></tr></table>
</div>
</div><p>Now, try writing a new file in the running container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ docker <span class="nb">exec</span> helloworld touch /hello-world.txt
rchaganti@ubuntu02:~$ docker <span class="nb">exec</span> helloworld ls -l
total <span class="m">60</span>
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 bin
drwxr-xr-x    <span class="m">5</span> root     root           <span class="m">340</span> Oct <span class="m">18</span> 12:40 dev
drwxr-xr-x    <span class="m">1</span> root     root          <span class="m">4096</span> Oct <span class="m">18</span> 12:40 etc
-rw-r--r--    <span class="m">1</span> root     root             <span class="m">0</span> Oct <span class="m">18</span> 13:11 hello-world.txt
-rw-r--r--    <span class="m">1</span> root     root            <span class="m">35</span> Oct <span class="m">16</span> 05:24 hello.txt
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 home
drwxr-xr-x    <span class="m">7</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 lib
drwxr-xr-x    <span class="m">5</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 media
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 mnt
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 opt
dr-xr-xr-x  <span class="m">252</span> root     root             <span class="m">0</span> Oct <span class="m">18</span> 12:40 proc
drwx------    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 root
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 run
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 sbin
drwxr-xr-x    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 srv
dr-xr-xr-x   <span class="m">12</span> root     root             <span class="m">0</span> Oct <span class="m">18</span> 12:40 sys
drwxrwxrwt    <span class="m">2</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 tmp
drwxr-xr-x    <span class="m">7</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 usr
drwxr-xr-x   <span class="m">12</span> root     root          <span class="m">4096</span> Aug  <span class="m">9</span> 08:47 var
</code></pre></td></tr></table>
</div>
</div><p>You can see that a new file got added inside the container. The view represents the contents of <code>MergedDir</code>. You can check the directory represented by <code>UpperDir</code> to see if it appears there as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo ls -l /var/lib/docker/overlay2/38705da4838102c3b9d2ae8aeb49844dac84dae95881df61fcffd1685caf9751/diff
total <span class="m">0</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">0</span> Oct <span class="m">18</span> 18:41 hello-world.txt
</code></pre></td></tr></table>
</div>
</div><p>If you follow the same steps you followed to determine the links between multiple image layers, you will see the association between the CoW layer and the lower immutable image layers.</p>


<div class="box" style="max-width:450px">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://ravichaganti.com/images/overlay-layers-2.png" />
    </div>
    <a href="https://ravichaganti.com/images/overlay-layers-2.png" itemprop="contentUrl"></a>
  </figure>
</div>

<p>This is one messy diagram but it demonstrates the point. The topmost layer is the CoW read/write layer and all layers below are read-only layers. I mentioned earlier that this is a temporary lived read/write layer. What happens if we stop and start the container? What happens if we remove the container?</p>
<p>Try it yourself. Hint: The file you created within the container survives a container restart.</p>
<p>Oh, BTW, you can use a tool called <a href="https://github.com/wagoodman/dive">dive</a> to look into the container images. While that is a great time saver, it is not as much fun as exploring the images manually &ndash; the hard way.</p>
<p>This is one long article but I had fun refining the notes I made to write this. This article showed how images are managed by the storage driver. You may have read elsewhere that container images can be used with any container engine. How is that made possible? Let us review that in the next article around Open Container Initiative (OCI) and the OCI image specification.</p>

        

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
position: relative;
text-align: left; 
height: 36px; 
width: 32px; 
float: left; 
text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: rgb(77, 77, 95);">Share on: </span><div id="share-buttons">
<div class="facebook" title="Share this on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=https:\/\/ravichaganti.com\/blog\/2022-10-18-understanding-container-images-the-fundamentals\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
<div class="twitter" title="Share this on Twitter" onclick="window.open('https://twitter.com/intent/tweet?text=https:\/\/ravichaganti.com\/blog\/2022-10-18-understanding-container-images-the-fundamentals\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
<div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=https:\/\/ravichaganti.com\/blog\/2022-10-18-understanding-container-images-the-fundamentals\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
<div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=https:\/\/ravichaganti.com\/blog\/2022-10-18-understanding-container-images-the-fundamentals\/');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>
      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ravikanth" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
        
          
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-3619442-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

        
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
        <p>All Rights Reserved.</p>
      
      
        ©
        
          2019 -
        
        2022
         Ravikanth Chaganti 
      
      
         · 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a> and hosted using <a href="https://pages.github.com/">GitHub Pages</a>.
      
      
    </section>
  </footer>

    </main>

    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-3619442-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
    

  </body>

</html>
