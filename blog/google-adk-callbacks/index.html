<!DOCTYPE html>
<html lang="en-us">
<head>
  
  <script>
    (function() {
      const stored = localStorage.getItem('theme-preference');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = stored || (prefersDark ? 'dark' : 'light');

      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>Google ADK - Callbacks | Ravikanth Chaganti</title>

  
  <meta name="description" content="Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. Or consider a flight booking agent where only admin users should be allowed to cancel reservations. You need to check permissions before a tool executes. Or maybe the same question is asked a hundred times a day, and each time you are paying for an LLM API call. You need to return cached responses and skip the model entirely. All of these share a common pattern. You need to run your code at specific points in the agent&rsquo;s execution pipeline, before or after the model call, before or after a tool runs, before or after the agent itself. This is where the callbacks feature comes into play.">
  <meta name="author" content="Ravikanth Chaganti">

  
  
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  

  
  <meta property="og:title" content="Google ADK - Callbacks">
  <meta property="og:description" content="Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. Or consider a flight booking agent where only admin users should be allowed to cancel reservations. You need to check permissions before a tool executes. Or maybe the same question is asked a hundred times a day, and each time you are paying for an LLM API call. You need to return cached responses and skip the model entirely. All of these share a common pattern. You need to run your code at specific points in the agent&rsquo;s execution pipeline, before or after the model call, before or after a tool runs, before or after the agent itself. This is where the callbacks feature comes into play.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://ravichaganti.com/blog/google-adk-callbacks/">
  <meta property="og:site_name" content="Ravikanth Chaganti">
  <meta property="og:locale" content="en_US">
  
  <meta property="og:image" content="https://ravichaganti.com/images/adk.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Google ADK - Callbacks">

  
  
    <meta property="article:published_time" content="2025-12-12T00:00:00Z">
    <meta property="article:modified_time" content="2025-12-12T00:00:00Z">
    <meta property="article:author" content="Ravikanth Chaganti">
    <meta property="article:section" content="Google">
    
  

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Google ADK - Callbacks">
  <meta name="twitter:description" content="Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. Or consider a flight booking agent where only admin users should be allowed to cancel reservations. You need to check permissions before a tool executes. Or maybe the same question is asked a hundred times a day, and each time you are paying for an LLM API call. You need to return cached responses and skip the model entirely. All of these share a common pattern. You need to run your code at specific points in the agent&rsquo;s execution pipeline, before or after the model call, before or after a tool runs, before or after the agent itself. This is where the callbacks feature comes into play.">
  <meta name="twitter:image" content="https://ravichaganti.com/images/adk.png">
  <meta name="twitter:site" content="@ravikanth">

  
  <link rel="canonical" href="https://ravichaganti.com/blog/google-adk-callbacks/">

  
  <link rel="alternate" type="application/rss+xml" href="https://ravichaganti.com/index.xml">

  
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" type="image/x-icon" href="/favicon.ico">

  
  <link rel="stylesheet" href="/css/main.css">

  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  
  






<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Google ADK - Callbacks",
  "description": "Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. …",
  "articleBody": "\"Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. Or consider a flight booking agent where only admin users should be allowed to cancel reservations. You need to check permissions before a tool executes. Or maybe the same question is asked a hundred times a day, and each time you are paying for an LLM API call. You need to return cached responses and skip the model entirely. All of these share a common pattern. You need to run your code at specific points in the agent\\u0026rsquo;s execution pipeline, before or after the model call, before or after a tool runs, before or after the agent itself. This is where the callbacks feature comes into play.\\nCallbacks Callbacks are user-defined functions that hook into an agent\\u0026rsquo;s execution pipeline at predefined checkpoints. You define them, attach them to an agent at creation time, and ADK calls them automatically at key stages. They let you observe, customize, and control behavior without modifying any ADK framework code. Think of them as checkpoints during the agent\\u0026rsquo;s process.\\nThe core mental model is a pipeline with six interception points grouped into three pairs.\\nThe agent lifecycle pair (before_agent_callback and after_agent_callback) wraps the entire agent execution. The model interaction pair (before_model_callback and after_model_callback) wraps the LLM API call. The tool execution pair (before_tool_callback and after_tool_callback) wraps each tool invocation. Every before_* callback acts as a gatekeeper. These callbacks return None to proceed to the next step, or return a specific object to skip the step and use that object as the output instead.\\nEvery after_* callback acts as a post-processor. Return None to pass through the original result, or return a specific object to replace it.\\nThese agent lifecycle callbacks are available on all agent types (BaseAgent, LlmAgent, SequentialAgent, ParallelAgent, LoopAgent). The model and tool callbacks are specific to LlmAgent. These callbacks are normal Python functions with specific parameters and return types.\\nAgent lifecycle callbacks The agent lifecycle callbacks are available before the agent starts work and after it finishes.\\nThe before_agent_callback is useful for setting up the environment needed for the agent\\u0026rsquo;s run. You can use this callback validate session state or even modify the invocation context before the agent\\u0026rsquo;s core logic starts.\\n1 2 def my_before_agent(callback_context: CallbackContext) -\\u0026gt; Optional[types.Content]: ... The Runner invokes this function and provides a CallbackContext object as input. This object contains information about the agent\\u0026rsquo;s current execution state, session state, and other references such as artifacts and memory.\\nThe after_agent_callback is useful for cleaning up after the agent run, performing post-execution checks, or modifying or augmenting the agent\\u0026rsquo;s final output.\\n1 2 def my_after_agent(callback_context: CallbackContext) -\\u0026gt; Optional[types.Content]: ... Model interaction callbacks The model interaction callbacks are specific to LlmAgent and wrap the LLM API calls.\\nThe before_model_callback is useful when you want to inspect or modify the request to the LLM API. For example, you can implement use cases such as adding a few-shot examples to the prompt sent to the LLM, implementing input guardrails, etc.\\n1 2 3 4 5 def my_before_model( callback_context: CallbackContext, llm_request: LlmRequest ) -\\u0026gt; Optional[LlmResponse]: ... The LlmRequest parameter is mutable. You can modify it in-place to change what the LLM receives.\\nThe after_model_callback is useful when you want to inspect or modify LLM generated response. With this callback, you can implement response reformatting, such as removing sensitive information.\\n1 2 3 4 5 def my_after_model( callback_context: CallbackContext, llm_response: LlmResponse ) -\\u0026gt; Optional[LlmResponse]: ... The LlmResponse object in the after_model_callback contains LLM generated response. Both agent lifecycle and model interaction callback pairs receive CallbackContext as input.\\nTool execution callbacks The tool_execution_callback is also specific to LlmAgent and wraps each individual tool invocation that the LLM might request.\\nThe before_tool_callback is useful when you want to determine whether tool execution should be allowed, inspect or modify tool arguments, or implement tool-level caching.\\n1 2 3 4 5 6 def my_before_tool( tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext ) -\\u0026gt; Optional[Dict]: ... The args parameter is mutable. We can modify it in-place to change what the tool receives, then return None to invoke the tool with the modified arguments.\\nThe after_tool_callback is useful for scenarios such as inspecting or modifying tool output before sending it to the LLM, and for logging tool results.\\n1 2 3 4 5 6 7 def my_after_tool( tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext, tool_response: Dict ) -\\u0026gt; Optional[Dict]: ... As seen so far, every callback receives a context object that provides access to the agent\\u0026rsquo;s session state, artifacts, and invocation metadata. There are two types of context, and understanding them is essential.\\nCallbackContext CallbackContext is used in agent lifecycle and model interaction callbacks. It provides access to the agent name, the invocation ID, and the session state.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from google.adk.agents.callback_context import CallbackContext # Properties available: callback_context.agent_name # Name of the current agent callback_context.invocation_id # Unique ID for this invocation callback_context.state # Session state (read/write) # State modifications are automatically tracked callback_context.state[\\u0026#34;my_key\\u0026#34;] = \\u0026#34;my_value\\u0026#34; current = callback_context.state.get(\\u0026#34;my_key\\u0026#34;, \\u0026#34;default\\u0026#34;) # Artifact operations: version = callback_context.save_artifact(\\u0026#34;filename.txt\\u0026#34;, types.Part(text=\\u0026#34;content\\u0026#34;)) part = callback_context.load_artifact(\\u0026#34;filename.txt\\u0026#34;) When you write callback_context.state[\\u0026quot;key\\u0026quot;] = value, the framework automatically captures this into EventActions.state_delta, which the SessionService processes via append_event. This is the same mechanism described in the article on sessions, state, and memory. You never need to manually construct events or call append_event inside callbacks.\\nToolContext ToolContext is used in tool callbacks. It extends CallbackContext with tool-specific capabilities.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 from google.adk.tools.tool_context import ToolContext # Everything from CallbackContext PLUS: tool_context.function_call_id # ID linking to the LLM\\u0026#39;s function call tool_context.actions # Direct access to EventActions # Authentication: tool_context.request_credential(auth_config) # Trigger OAuth flow tool_context.get_auth_response(auth_config) # Retrieve credentials # Memory \\u0026amp; Artifacts: results = tool_context.search_memory(\\u0026#34;query\\u0026#34;) # Search memory service artifacts = tool_context.list_artifacts() # List available artifacts # Summarization control: tool_context.actions.skip_summarization = True # Skip LLM summarization of tool result State prefixes in callbacks State keys in callbacks use the same prefix scoping system described in the sessions, state, and memory article.\\n1 2 3 4 5 6 7 8 9 10 11 # Application-wide state (shared across all users/sessions) callback_context.state[\\u0026#34;app:global_config\\u0026#34;] = {\\u0026#34;max_retries\\u0026#34;: 3} # User-specific state (shared across sessions for this user) callback_context.state[\\u0026#34;user:preferences\\u0026#34;] = {\\u0026#34;language\\u0026#34;: \\u0026#34;es\\u0026#34;} # Temporary state (cleared between invocations) callback_context.state[\\u0026#34;temp:current_step\\u0026#34;] = \\u0026#34;processing\\u0026#34; # No prefix = session-scoped (default, persists within session) callback_context.state[\\u0026#34;conversation_topic\\u0026#34;] = \\u0026#34;weather\\u0026#34; Registering callbacks You register callbacks by passing them as parameters when creating an agent. Here is an example that registers all six callbacks on an LlmAgent.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from google.adk.agents import LlmAgent agent = LlmAgent( name=\\u0026#34;MyAgent\\u0026#34;, model=\\u0026#34;gemini-2.0-flash\\u0026#34;, instruction=\\u0026#34;You are a helpful assistant.\\u0026#34;, tools=[my_tool], before_agent_callback=my_before_agent, after_agent_callback=my_after_agent, before_model_callback=my_before_model, after_model_callback=my_after_model, before_tool_callback=my_before_tool, after_tool_callback=my_after_tool, ) You can also pass a list of callbacks. When a list is provided, the callbacks execute sequentially. The first callback that returns a non-None value stops the chain, and subsequent callbacks in the list do not execute.\\n1 2 3 4 5 6 7 8 9 10 11 agent = LlmAgent( name=\\u0026#34;ProductionAgent\\u0026#34;, model=\\u0026#34;gemini-2.0-flash\\u0026#34;, instruction=\\u0026#34;You are helpful.\\u0026#34;, before_model_callback=[ check_cache, # Returns LlmResponse if cache hit content_guardrail, # Returns LlmResponse if policy violation inject_context, # Modifies request, returns None log_request, # Logs, returns None ], ) In this example, if check_cache finds a cache hit, it returns an LlmResponse, and the remaining three callbacks are skipped entirely. Callbacks can be either synchronous or asynchronous functions.\\nFor workflow agents (SequentialAgent, ParallelAgent, LoopAgent), only agent lifecycle callbacks (before_agent_callback and after_agent_callback) are available, since these agents do not interact directly with an LLM or tools.\\nWith the basics out of the way, let us look at some sample use cases.\\nObservability logging The simplest use of callbacks is logging. Every callback returns None, so the agent\\u0026rsquo;s behavior is unaffected. This provides a complete picture of the agent\\u0026rsquo;s execution for debugging and monitoring.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 import logging from google.adk.agents import LlmAgent from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse, LlmRequest from google.adk.tools import BaseTool, ToolContext from typing import Optional, Dict, Any from google.genai import types logger = logging.getLogger(__name__) def log_before_agent(callback_context: CallbackContext) -\\u0026gt; Optional[types.Content]: logger.info(f\\u0026#34;[{callback_context.agent_name}] Agent starting - invocation: {callback_context.invocation_id}\\u0026#34;) return None def log_after_agent(callback_context: CallbackContext) -\\u0026gt; Optional[types.Content]: logger.info(f\\u0026#34;[{callback_context.agent_name}] Agent completed\\u0026#34;) return None def log_before_model(callback_context: CallbackContext, llm_request: LlmRequest) -\\u0026gt; Optional[LlmResponse]: msg_count = len(llm_request.contents) logger.info(f\\u0026#34;[{callback_context.agent_name}] Sending {msg_count} messages to LLM\\u0026#34;) return None def log_after_model(callback_context: CallbackContext, llm_response: LlmResponse) -\\u0026gt; Optional[LlmResponse]: has_tool_calls = any( part.function_call for part in (llm_response.content.parts or []) ) logger.info(f\\u0026#34;[{callback_context.agent_name}] LLM responded (tool_calls={has_tool_calls})\\u0026#34;) return None def log_before_tool(tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext) -\\u0026gt; Optional[Dict]: logger.info(f\\u0026#34;[Tool: {tool.name}] Executing with args: {args}\\u0026#34;) return None def log_after_tool(tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext, tool_response: Dict) -\\u0026gt; Optional[Dict]: logger.info(f\\u0026#34;[Tool: {tool.name}] Returned: {tool_response}\\u0026#34;) return None agent = LlmAgent( name=\\u0026#34;ObservableAgent\\u0026#34;, model=\\u0026#34;gemini-2.0-flash\\u0026#34;, instruction=\\u0026#34;You are a helpful assistant.\\u0026#34;, before_agent_callback=log_before_agent, after_agent_callback=log_after_agent, before_model_callback=log_before_model, after_model_callback=log_after_model, before_tool_callback=log_before_tool, after_tool_callback=log_after_tool, ) Every callback returns None, so the agent operates exactly as it would without callbacks. The logs give you a complete trace of what happened and when.\\nInput guardrails A common requirement is to block prompts containing forbidden content before they reach the LLM. The before_model_callback is the natural place for this, as it fires just before the LLM API call.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 from google.adk.agents import LlmAgent from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse, LlmRequest from typing import Optional from google.genai import types BLOCKED_KEYWORDS = [\\u0026#34;hack\\u0026#34;, \\u0026#34;exploit\\u0026#34;, \\u0026#34;bypass security\\u0026#34;, \\u0026#34;illegal\\u0026#34;] def content_guardrail( callback_context: CallbackContext, llm_request: LlmRequest ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Block requests containing forbidden keywords.\\u0026#34;\\u0026#34;\\u0026#34; all_text = \\u0026#34;\\u0026#34; for content in llm_request.contents: for part in content.parts: if part.text: all_text += part.text.lower() + \\u0026#34; \\u0026#34; for keyword in BLOCKED_KEYWORDS: if keyword in all_text: callback_context.state[\\u0026#34;temp:last_violation\\u0026#34;] = keyword callback_context.state[\\u0026#34;user:violation_count\\u0026#34;] = ( callback_context.state.get(\\u0026#34;user:violation_count\\u0026#34;, 0) + 1 ) return LlmResponse( content=types.Content( role=\\u0026#34;model\\u0026#34;, parts=[types.Part( text=\\u0026#34;I\\u0026#39;m unable to help with that request. \\u0026#34; \\u0026#34;It appears to involve content that violates our usage policy.\\u0026#34; )] ) ) return None agent = LlmAgent( name=\\u0026#34;GuardedAgent\\u0026#34;, model=\\u0026#34;gemini-2.0-flash\\u0026#34;, instruction=\\u0026#34;You are a helpful assistant.\\u0026#34;, before_model_callback=content_guardrail, ) When a blocked keyword is detected, the callback returns an LlmResponse directly. This skips the LLM call entirely; the user sees the policy message, and you pay no API call cost. The violation is tracked using the temp: prefix for the current invocation and the user: prefix for persistent tracking across sessions.\\nOutput sanitization After the LLM responds, you may need to clean its output before the user sees it. The after_model_callback lets you inspect and modify the LLM\\u0026rsquo;s response.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 import re from copy import deepcopy from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse from typing import Optional EMAIL_PATTERN = re.compile(r\\u0026#39;\\\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\\\.[A-Z|a-z]{2,}\\\\b\\u0026#39;) PHONE_PATTERN = re.compile(r\\u0026#39;\\\\b(\\\\+?1[-.\\\\s]?)?\\\\(?\\\\d{3}\\\\)?[-.\\\\s]?\\\\d{3}[-.\\\\s]?\\\\d{4}\\\\b\\u0026#39;) def sanitize_llm_output( callback_context: CallbackContext, llm_response: LlmResponse ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Redact PII from model responses.\\u0026#34;\\u0026#34;\\u0026#34; if not llm_response.content or not llm_response.content.parts: return None modified = False new_parts = [] for part in llm_response.content.parts: if part.function_call: new_parts.append(part) continue if part.text: new_text = EMAIL_PATTERN.sub(\\u0026#34;[EMAIL REDACTED]\\u0026#34;, part.text) new_text = PHONE_PATTERN.sub(\\u0026#34;[PHONE REDACTED]\\u0026#34;, new_text) if new_text != part.text: modified = True new_parts.append(deepcopy(part)) new_parts[-1].text = new_text else: new_parts.append(part) if modified: new_response = deepcopy(llm_response) new_response.content.parts = new_parts return new_response return None There is an important detail here. The callback checks for part.function_call and skips those parts. If your after_model_callback modifies function call responses, it breaks tool execution. Always check for function calls first and pass them through unchanged. Also note the use of deepcopy when building a modified LlmResponse to avoid corrupting the original if other callbacks need it.\\nTool authorization The before_tool_callback lets you enforce access control before a tool executes. This is important for tools that perform destructive operations, such as deleting records or cancelling bookings.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 from google.adk.tools import BaseTool, ToolContext from typing import Dict, Any, Optional TOOL_PERMISSIONS = { \\u0026#34;delete_record\\u0026#34;: [\\u0026#34;admin\\u0026#34;], \\u0026#34;cancel_booking\\u0026#34;: [\\u0026#34;admin\\u0026#34;, \\u0026#34;manager\\u0026#34;], \\u0026#34;search_flights\\u0026#34;: [\\u0026#34;admin\\u0026#34;, \\u0026#34;manager\\u0026#34;, \\u0026#34;user\\u0026#34;], } def authorize_tool_usage( tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext ) -\\u0026gt; Optional[Dict]: \\u0026#34;\\u0026#34;\\u0026#34;Check user role before allowing tool execution.\\u0026#34;\\u0026#34;\\u0026#34; user_role = tool_context.state.get(\\u0026#34;user:role\\u0026#34;, \\u0026#34;user\\u0026#34;) allowed_roles = TOOL_PERMISSIONS.get(tool.name, [\\u0026#34;admin\\u0026#34;]) if user_role not in allowed_roles: return { \\u0026#34;error\\u0026#34;: f\\u0026#34;Access denied. Tool \\u0026#39;{tool.name}\\u0026#39; requires one of {allowed_roles}. \\u0026#34; f\\u0026#34;Your role: \\u0026#39;{user_role}\\u0026#39;.\\u0026#34; } return None For this to work, the user:role must be set in the session state when the session is created. Because the key uses the user: prefix, it persists across sessions for that user within the same application.\\nResponse caching Response caching is a powerful pattern that uses a before_model_callback and after_model_callback pair working together. The before callback checks the cache and returns a stored response if found (skipping the LLM call). The after callback stores new responses in the cache.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import hashlib from copy import deepcopy from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse, LlmRequest from typing import Optional def _cache_key(llm_request: LlmRequest) -\\u0026gt; str: last_msg = \\u0026#34;\\u0026#34; if llm_request.contents and llm_request.contents[-1].parts: last_msg = llm_request.contents[-1].parts[0].text or \\u0026#34;\\u0026#34; return f\\u0026#34;temp:cache:{hashlib.md5(last_msg.encode()).hexdigest()}\\u0026#34; def check_cache_before_model( callback_context: CallbackContext, llm_request: LlmRequest ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Return cached response if available.\\u0026#34;\\u0026#34;\\u0026#34; key = _cache_key(llm_request) cached = callback_context.state.get(key) if cached: return LlmResponse( content=types.Content(role=\\u0026#34;model\\u0026#34;, parts=[types.Part(text=cached)]) ) return None def store_cache_after_model( callback_context: CallbackContext, llm_response: LlmResponse ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Cache the response for future use.\\u0026#34;\\u0026#34;\\u0026#34; if llm_response.content and llm_response.content.parts: text = llm_response.content.parts[0].text if text: key = f\\u0026#34;temp:cache:{hashlib.md5(text.encode()).hexdigest()}\\u0026#34; callback_context.state[key] = text return None The cache key uses the temp: prefix because cached responses are only relevant within the current invocation. If you want responses to persist across invocations, use a session-scoped key (no prefix) instead.\\nDynamic instruction injection One of the most practical callback patterns is dynamically modifying the agent\\u0026rsquo;s system instructions based on state. The before_model_callback can modify the llm_request in-place to inject context that the LLM would not otherwise have.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse, LlmRequest from typing import Optional from google.genai import types def inject_user_context( callback_context: CallbackContext, llm_request: LlmRequest ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Dynamically inject user context into the system instruction.\\u0026#34;\\u0026#34;\\u0026#34; user_lang = callback_context.state.get(\\u0026#34;user:language\\u0026#34;, \\u0026#34;English\\u0026#34;) user_tier = callback_context.state.get(\\u0026#34;user:tier\\u0026#34;, \\u0026#34;free\\u0026#34;) conversation_count = callback_context.state.get(\\u0026#34;user:conversation_count\\u0026#34;, 0) additions = [] if user_lang != \\u0026#34;English\\u0026#34;: additions.append(f\\u0026#34;Respond in {user_lang}.\\u0026#34;) if user_tier == \\u0026#34;premium\\u0026#34;: additions.append(\\u0026#34;This is a premium user. Provide detailed, comprehensive answers.\\u0026#34;) else: additions.append(\\u0026#34;This is a free-tier user. Keep responses concise.\\u0026#34;) if conversation_count == 0: additions.append(\\u0026#34;This is the user\\u0026#39;s first conversation. Be welcoming.\\u0026#34;) context_text = \\u0026#34; \\u0026#34;.join(additions) current_instruction = llm_request.config.system_instruction if current_instruction and current_instruction.parts: original_text = current_instruction.parts[0].text or \\u0026#34;\\u0026#34; current_instruction.parts[0].text = f\\u0026#34;{original_text}\\\\n\\\\n{context_text}\\u0026#34; else: llm_request.config.system_instruction = types.Content( role=\\u0026#34;system\\u0026#34;, parts=[types.Part(text=context_text)] ) callback_context.state[\\u0026#34;user:conversation_count\\u0026#34;] = conversation_count + 1 return None This callback modifies the llm_request in-place and returns None, so the LLM call proceeds normally but with enriched instructions. Note that ADK also provides simpler alternatives for instruction injection using {key} template syntax directly in agent instructions, as described in the sessions, state, and memory article. Use the callback approach when you need conditional logic that goes beyond simple value substitution.\\nArtifact handling in callbacks Callbacks can save and load artifacts, which are files or data blobs stored alongside the session. This is useful for persisting generated content, such as reports or processed results.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse from google.genai import types from typing import Optional import json def save_report_artifact( callback_context: CallbackContext, llm_response: LlmResponse ) -\\u0026gt; Optional[LlmResponse]: \\u0026#34;\\u0026#34;\\u0026#34;Save long model responses as downloadable artifacts.\\u0026#34;\\u0026#34;\\u0026#34; if not llm_response.content or not llm_response.content.parts: return None text = llm_response.content.parts[0].text or \\u0026#34;\\u0026#34; if len(text) \\u0026gt; 500: callback_context.save_artifact( \\u0026#34;generated_report.md\\u0026#34;, types.Part(text=text) ) metadata = { \\u0026#34;artifact\\u0026#34;: \\u0026#34;generated_report.md\\u0026#34;, \\u0026#34;length\\u0026#34;: len(text), \\u0026#34;agent\\u0026#34;: callback_context.agent_name } callback_context.save_artifact( \\u0026#34;report_metadata.json\\u0026#34;, types.Part(text=json.dumps(metadata)) ) return None Putting it all together Here is a complete example that combines multiple callback patterns into a production-ready agent. This agent uses guardrails, caching, tool authorization, and logging.\\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 import asyncio import logging import hashlib from google.adk.agents import LlmAgent from google.adk.agents.callback_context import CallbackContext from google.adk.models import LlmResponse, LlmRequest from google.adk.tools import BaseTool, ToolContext from google.adk.sessions import InMemorySessionService from google.adk.runners import Runner from google.genai import types from typing import Optional, Dict, Any logger = logging.getLogger(__name__) BLOCKED_KEYWORDS = [\\u0026#34;hack\\u0026#34;, \\u0026#34;exploit\\u0026#34;] # --- Callbacks --- def guardrail(callback_context: CallbackContext, llm_request: LlmRequest) -\\u0026gt; Optional[LlmResponse]: all_text = \\u0026#34; \\u0026#34;.join( part.text.lower() for content in llm_request.contents for part in content.parts if part.text ) for kw in BLOCKED_KEYWORDS: if kw in all_text: callback_context.state[\\u0026#34;user:violations\\u0026#34;] = callback_context.state.get(\\u0026#34;user:violations\\u0026#34;, 0) + 1 return LlmResponse( content=types.Content( role=\\u0026#34;model\\u0026#34;, parts=[types.Part(text=\\u0026#34;Request blocked by policy.\\u0026#34;)] ) ) return None def log_model_call(callback_context: CallbackContext, llm_request: LlmRequest) -\\u0026gt; Optional[LlmResponse]: logger.info(f\\u0026#34;[{callback_context.agent_name}] LLM call with {len(llm_request.contents)} messages\\u0026#34;) return None def authorize_tool(tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext) -\\u0026gt; Optional[Dict]: role = tool_context.state.get(\\u0026#34;user:role\\u0026#34;, \\u0026#34;user\\u0026#34;) if tool.name == \\u0026#34;delete_booking\\u0026#34; and role != \\u0026#34;admin\\u0026#34;: return {\\u0026#34;error\\u0026#34;: \\u0026#34;Admin access required for deletion\\u0026#34;} return None def log_tool_call(tool: BaseTool, args: Dict[str, Any], tool_context: ToolContext) -\\u0026gt; Optional[Dict]: logger.info(f\\u0026#34;[Tool: {tool.name}] args={args}\\u0026#34;) return None # --- Tools --- def search_bookings(query: str, tool_context: ToolContext) -\\u0026gt; dict: \\u0026#34;\\u0026#34;\\u0026#34;Search for existing bookings.\\u0026#34;\\u0026#34;\\u0026#34; tool_context.state[\\u0026#34;last_search\\u0026#34;] = query return {\\u0026#34;bookings\\u0026#34;: [{\\u0026#34;id\\u0026#34;: \\u0026#34;BK001\\u0026#34;, \\u0026#34;flight\\u0026#34;: \\u0026#34;AA101\\u0026#34;, \\u0026#34;status\\u0026#34;: \\u0026#34;confirmed\\u0026#34;}]} def delete_booking(booking_id: str, tool_context: ToolContext) -\\u0026gt; dict: \\u0026#34;\\u0026#34;\\u0026#34;Delete a booking by ID. Admin only.\\u0026#34;\\u0026#34;\\u0026#34; return {\\u0026#34;status\\u0026#34;: \\u0026#34;deleted\\u0026#34;, \\u0026#34;booking_id\\u0026#34;: booking_id} # --- Agent --- support_agent = LlmAgent( name=\\u0026#34;SupportAgent\\u0026#34;, model=\\u0026#34;gemini-2.0-flash\\u0026#34;, instruction=\\u0026#34;You are a booking support agent. Help users search and manage bookings.\\u0026#34;, tools=[search_bookings, delete_booking], before_model_callback=[guardrail, log_model_call], before_tool_callback=[authorize_tool, log_tool_call], output_key=\\u0026#34;last_response\\u0026#34; ) # --- Run --- async def main(): session_service = InMemorySessionService() runner = Runner( agent=support_agent, app_name=\\u0026#34;support_app\\u0026#34;, session_service=session_service ) session = await session_service.create_session( app_name=\\u0026#34;support_app\\u0026#34;, user_id=\\u0026#34;user1\\u0026#34;, state={\\u0026#34;user:name\\u0026#34;: \\u0026#34;Ravi\\u0026#34;, \\u0026#34;user:role\\u0026#34;: \\u0026#34;user\\u0026#34;} ) # Turn 1: Normal request msg1 = types.Content(parts=[types.Part(text=\\u0026#34;Find my bookings\\u0026#34;)], role=\\u0026#34;user\\u0026#34;) async for event in runner.run_async( user_id=\\u0026#34;user1\\u0026#34;, session_id=session.id, new_message=msg1 ): if event.is_final_response() and event.content: print(f\\u0026#34;Agent: {event.content.parts[0].text}\\u0026#34;) # Turn 2: Attempt deletion without admin role msg2 = types.Content(parts=[types.Part(text=\\u0026#34;Delete booking BK001\\u0026#34;)], role=\\u0026#34;user\\u0026#34;) async for event in runner.run_async( user_id=\\u0026#34;user1\\u0026#34;, session_id=session.id, new_message=msg2 ): if event.is_final_response() and event.content: print(f\\u0026#34;Agent: {event.content.parts[0].text}\\u0026#34;) # Turn 3: Blocked request msg3 = types.Content(parts=[types.Part(text=\\u0026#34;Help me hack the system\\u0026#34;)], role=\\u0026#34;user\\u0026#34;) async for event in runner.run_async( user_id=\\u0026#34;user1\\u0026#34;, session_id=session.id, new_message=msg3 ): if event.is_final_response() and event.content: print(f\\u0026#34;Agent: {event.content.parts[0].text}\\u0026#34;) # Check state s = await session_service.get_session( app_name=\\u0026#34;support_app\\u0026#34;, user_id=\\u0026#34;user1\\u0026#34;, session_id=session.id ) print(f\\u0026#34;Violations: {s.state.get(\\u0026#39;user:violations\\u0026#39;, 0)}\\u0026#34;) asyncio.run(main()) When you run this, you can observe how the callback chain works in practice.\\n1 2 3 4 5 6 \\u0026gt; python.exe .\\\\callbacks-demo.py Agent: OK. I found one booking with ID BK001 for flight AA101. Is that correct? Agent: I am sorry, I do not have the permission to delete this booking. Agent: Request blocked by policy. Violations: 1 The first request flows through normally. The guardrail finds no blocked keywords, logging fires, and the search_bookings tool executes. The second request attempts to use the delete_booking tool, but the authorize_tool callback blocks it because the user\\u0026rsquo;s role is user, not admin. The third request is blocked at the model level by the guardrail before the LLM is even called.\\nWhen writing callbacks, keep a few guidelines in mind. Each callback should do one thing. Compose multiple concerns using callback lists rather than building monolithic functions. Always wrap callback logic in try/except. A crashing callback can break the entire agent invocation. When in doubt, fail open (return None) and log the error.\\n1 2 3 4 5 6 7 def safe_callback(ctx: CallbackContext) -\\u0026gt; Optional[types.Content]: try: # ... your logic ... return None except Exception as e: logger.error(f\\u0026#34;Callback error: {e}\\u0026#34;) return None Callbacks execute synchronously in the agent\\u0026rsquo;s processing loop. Avoid blocking I/O or heavy computation in sync callbacks. Use async callbacks when making network calls. Use descriptive function names that convey purpose — authorize_tool_usage is better than before_tool_cb.\\nFor state management within callbacks, use specific keys with appropriate prefixes (app:, user:, temp:). Changes are visible immediately within the current invocation and persisted at event processing time. The full mechanics of state scoping and persistence are described in the sessions, state, and memory article.\\nThere are also a few common pitfalls to be aware of. If your observation-only callback accidentally returns a value, it will override the step\\u0026rsquo;s behavior. When building a modified LlmResponse in after_model_callback, use deepcopy to avoid corrupting the original. If your after_model_callback modifies text responses, always check for part.function_call first and skip those — modifying function call responses breaks tool execution. And be careful with state key collisions when multiple callbacks write to the same key without coordination; use namespaced keys.\\nUnderstanding how callbacks integrate with the agent execution pipeline is essential for building production-ready agents. This article explored the six callback types, their signatures and return behavior, and demonstrated practical patterns from simple logging through input guardrails, output sanitization, tool authorization, response caching, and dynamic instruction injection. These patterns, combined with the session state management covered in the sessions, state, and memory article, provide the building blocks for creating robust, observable, and customizable agent workflows. I recommend experimenting with these patterns in your own agents.\\n\"",
  "url": "https:\/\/ravichaganti.com\/blog\/google-adk-callbacks\/",
  "datePublished": "2025-12-12T00:00:00Z",
  "dateModified": "2025-12-12T00:00:00Z",
  "author": {
    "@type": "Person",
    "name": "Ravikanth Chaganti"
    ,"sameAs": ["https://twitter.com/ravikanth"]
  },
  "publisher": {
    "@type": "Person",
    "name": "Ravikanth Chaganti",
    "sameAs": ["https://twitter.com/ravikanth"]
  },
  
  "image": {
    "@type": "ImageObject",
    "url": "https:\/\/ravichaganti.com\/images\/adk.png",
    "width": 1200,
    "height": 630
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/ravichaganti.com\/blog\/google-adk-callbacks\/"
  },
  
  "articleSection": "\"Google\"",
  
  
  
  "timeRequired": "PT18M",
  
  "inLanguage": "en-US",
  "isAccessibleForFree": true
}
</script>




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https:\/\/ravichaganti.com\/"
    }
    ,
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https:\/\/ravichaganti.com\/blog/"
    }
    
    ,
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Google",
      "item": "https:\/\/ravichaganti.com\/categories/google/"
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": "Google ADK - Callbacks",
      "item": "https:\/\/ravichaganti.com\/blog\/google-adk-callbacks\/"
    }
    
    
  ]
}
</script>


</head>

<body class="flex flex-col min-h-screen bg-gray-50 dark:bg-dark-bg">
  <header class="sticky top-0 z-50 bg-white dark:bg-dark-bg-secondary shadow-md relative">
  <nav class="container mx-auto px-4 py-4">
    <div class="flex items-center justify-between">
      
      <div class="flex items-center">
        <a href="https://ravichaganti.com/" class="flex items-center gap-3 text-gray-900 dark:text-dark-text hover:text-primary transition-colors no-underline group">
          
          <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
            <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="2" class="group-hover:stroke-primary transition-colors"/>
            <text x="20" y="26" font-family="sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="currentColor">RC</text>
          </svg>
          
          <div class="flex flex-col leading-tight">
            <span class="text-xs sm:text-sm font-semibold">Cloud Native</span>
            <span class="text-xs sm:text-sm font-semibold">Agentic AI</span>
            <span class="text-xs sm:text-sm font-semibold">Infrastructure</span>
          </div>
        </a>
      </div>

      
      <div class="hidden md:flex items-center space-x-8">
        
          <a href="/blog/" class="text-gray-700 dark:text-dark-text-secondary hover:text-primary font-medium transition-all no-underline hover:underline hover:decoration-blue-500 hover:decoration-2 hover:underline-offset-4">
            Blog
          </a>
        
          <a href="/books/" class="text-gray-700 dark:text-dark-text-secondary hover:text-primary font-medium transition-all no-underline hover:underline hover:decoration-blue-500 hover:decoration-2 hover:underline-offset-4">
            Books
          </a>
        
          <a href="https://learn.ravichaganti.com" target="_blank" rel="noopener noreferrer" class="text-gray-700 dark:text-dark-text-secondary hover:text-primary font-medium transition-all no-underline hover:underline hover:decoration-blue-500 hover:decoration-2 hover:underline-offset-4">
            Courses
          </a>
        
          <a href="https://www.linkedin.com/build-relation/newsletter-follow?entityUrn=7418529089365520384" target="_blank" rel="noopener noreferrer" class="text-gray-700 dark:text-dark-text-secondary hover:text-primary font-medium transition-all no-underline hover:underline hover:decoration-blue-500 hover:decoration-2 hover:underline-offset-4">
            Newsletter
          </a>
        
          <a href="/about/" class="text-gray-700 dark:text-dark-text-secondary hover:text-primary font-medium transition-all no-underline hover:underline hover:decoration-blue-500 hover:decoration-2 hover:underline-offset-4">
            About
          </a>
        
      </div>

      
      <div class="hidden md:flex items-center space-x-4 relative" id="social-search-container">
        
        <div id="social-icons" class="flex items-center space-x-3">
          

<a href="https://twitter.com/ravikanth" target="_blank" rel="noopener noreferrer" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors" aria-label="Twitter">
  <svg class="w-5 h-5 text-gray-700 dark:text-dark-text hover:text-primary dark:hover:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
  </svg>
</a>



<a href="https://github.com/rchaganti" target="_blank" rel="noopener noreferrer" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors" aria-label="GitHub">
  <svg class="w-5 h-5 text-gray-700 dark:text-dark-text hover:text-primary dark:hover:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/>
  </svg>
</a>



<a href="https://linkedin.com/in/rchaganti" target="_blank" rel="noopener noreferrer" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors" aria-label="LinkedIn">
  <svg class="w-5 h-5 text-gray-700 dark:text-dark-text hover:text-primary dark:hover:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
  </svg>
</a>




        </div>

        
        <button
          id="theme-toggle"
          class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors"
          aria-label="Toggle dark mode"
          title="Toggle dark mode"
        >
          
          <svg class="theme-icon-sun w-5 h-5 text-gray-700 dark:text-dark-text hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>

          
          <svg class="theme-icon-moon w-5 h-5 text-gray-700 dark:text-dark-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>

        
        <button id="search-toggle" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors" aria-label="Search">
          <svg class="w-5 h-5 text-gray-700 dark:text-dark-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>

        
        <div id="search-box" class="hidden absolute top-full right-0 mt-2 w-80 bg-white dark:bg-dark-bg-secondary shadow-lg p-4 z-50 rounded-lg">
          





<div class="relative search-container" data-mode="desktop">
  <input
    type="text"
    id="search-input-desktop"
    placeholder="Search articles..."
    class="search-input w-full px-4 py-2 text-sm border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-bg-secondary text-gray-900 dark:text-dark-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
    aria-label="Search"
    autocomplete="off"
  >
  <div id="search-results-desktop" class="search-results absolute top-full mt-2 w-full bg-white dark:bg-dark-bg-secondary border border-gray-200 dark:border-dark-border rounded-lg shadow-xl hidden max-h-80 overflow-y-auto z-50">
    
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>


<script>
(function() {
  let headerFuse;
  let headerSearchData = [];
  let searchInitialized = false;

  
  fetch('/index.json')
    .then(response => response.json())
    .then(data => {
      headerSearchData = data;

      
      const options = {
        keys: [
          { name: 'title', weight: 3 },
          { name: 'excerpt', weight: 2 },
          { name: 'content', weight: 1 },
          { name: 'categories', weight: 1.5 },
          { name: 'series', weight: 1.5 }
        ],
        threshold: 0.4,
        includeScore: true,
        ignoreLocation: true,
        minMatchCharLength: 2
      };

      headerFuse = new Fuse(headerSearchData, options);
      searchInitialized = true;
    })
    .catch(error => console.error('Error loading search index:', error));

  
  function renderResults(results, resultsContainer) {
    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-dark-text-secondary text-sm">No results found</div>';
      resultsContainer.classList.remove('hidden');
      return;
    }

    resultsContainer.innerHTML = results.slice(0, 5).map(result => {
      const item = result.item;
      const date = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      return `
        <a href="${item.permalink}" class="block p-3 hover:bg-gray-50 dark:hover:bg-dark-bg-tertiary border-b border-gray-100 dark:border-dark-border last:border-b-0 no-underline">
          <div class="font-medium text-sm text-gray-900 dark:text-dark-text mb-1">${item.title}</div>
          <div class="flex items-center gap-2 mb-1 flex-wrap">
            <span class="text-xs text-gray-500 dark:text-dark-text-secondary">${date}</span>
            ${item.categories ? item.categories.slice(0, 2).map(cat => `
              <span class="inline-block px-1.5 py-0.5 text-xs rounded bg-primary/10 dark:bg-primary/20 text-primary dark:text-blue-400">
                ${cat}
              </span>
            `).join('') : ''}
          </div>
          ${item.excerpt ? `<p class="text-xs text-gray-600 dark:text-dark-text-secondary line-clamp-2">${item.excerpt}</p>` : ''}
        </a>
      `;
    }).join('');

    resultsContainer.classList.remove('hidden');
  }

  
  function initSearchContainers() {
    const containers = document.querySelectorAll('.search-container');

    containers.forEach(container => {
      const searchInput = container.querySelector('.search-input');
      const searchResults = container.querySelector('.search-results');

      if (!searchInput || !searchResults) return;

      
      searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        if (query.length < 2 || !searchInitialized) {
          searchResults.classList.add('hidden');
          return;
        }

        const results = headerFuse.search(query);
        renderResults(results, searchResults);
      });

      
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          searchResults.classList.add('hidden');
          searchInput.blur();
        }
      });
    });

    
    function closeAllResults(e) {
      const containers = document.querySelectorAll('.search-container');
      containers.forEach(container => {
        const searchResults = container.querySelector('.search-results');
        if (searchResults && !container.contains(e.target)) {
          searchResults.classList.add('hidden');
        }
      });
    }

    document.addEventListener('click', closeAllResults);
    document.addEventListener('touchend', closeAllResults);
  }

  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearchContainers);
  } else {
    initSearchContainers();
  }
})();
</script>


        </div>
      </div>

      
      <div class="md:hidden flex items-center gap-2">
        
        <button id="search-toggle-mobile" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors" aria-label="Search">
          <svg class="w-5 h-5 text-gray-700 dark:text-dark-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>

        
        <button
          id="theme-toggle-mobile"
          class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded-full transition-colors"
          aria-label="Toggle dark mode"
          title="Toggle dark mode"
        >
          
          <svg class="theme-icon-sun w-5 h-5 text-gray-700 dark:text-dark-text hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>

          
          <svg class="theme-icon-moon w-5 h-5 text-gray-700 dark:text-dark-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>

        
        <button id="mobile-menu-toggle" class="p-2 hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary rounded" aria-label="Menu">
          <svg class="w-6 h-6 text-gray-700 dark:text-dark-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
    </div>

    
    <div id="search-box-mobile" class="hidden md:hidden absolute top-full left-0 right-0 bg-white dark:bg-dark-bg-secondary shadow-lg p-4 z-50">
      





<div class="relative search-container" data-mode="mobile">
  <input
    type="text"
    id="search-input-mobile"
    placeholder="Search articles..."
    class="search-input w-full px-4 py-2 text-sm border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-bg-secondary text-gray-900 dark:text-dark-text rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
    aria-label="Search"
    autocomplete="off"
  >
  <div id="search-results-mobile" class="search-results absolute top-full mt-2 w-full bg-white dark:bg-dark-bg-secondary border border-gray-200 dark:border-dark-border rounded-lg shadow-xl hidden max-h-80 overflow-y-auto z-50">
    
  </div>
</div>




    </div>

    
    <div id="mobile-menu" class="hidden md:hidden mt-4 pb-4">
      
        <a href="/blog/" class="block py-3 px-2 text-base text-gray-700 dark:text-dark-text-secondary hover:text-primary hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary transition-colors no-underline rounded-md min-h-[44px] flex items-center">
          Blog
        </a>
      
        <a href="/books/" class="block py-3 px-2 text-base text-gray-700 dark:text-dark-text-secondary hover:text-primary hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary transition-colors no-underline rounded-md min-h-[44px] flex items-center">
          Books
        </a>
      
        <a href="https://learn.ravichaganti.com" target="_blank" rel="noopener noreferrer" class="block py-3 px-2 text-base text-gray-700 dark:text-dark-text-secondary hover:text-primary hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary transition-colors no-underline rounded-md min-h-[44px] flex items-center">
          Courses
        </a>
      
        <a href="https://www.linkedin.com/build-relation/newsletter-follow?entityUrn=7418529089365520384" target="_blank" rel="noopener noreferrer" class="block py-3 px-2 text-base text-gray-700 dark:text-dark-text-secondary hover:text-primary hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary transition-colors no-underline rounded-md min-h-[44px] flex items-center">
          Newsletter
        </a>
      
        <a href="/about/" class="block py-3 px-2 text-base text-gray-700 dark:text-dark-text-secondary hover:text-primary hover:bg-gray-100 dark:hover:bg-dark-bg-tertiary transition-colors no-underline rounded-md min-h-[44px] flex items-center">
          About
        </a>
      
    </div>
  </nav>

  
  
    <div id="reading-progress" class="absolute bottom-0 left-0 w-full h-1 bg-primary transition-all duration-200 z-10" style="width: 0%; max-width: 100%;"></div>
  
</header>


<script>
  document.getElementById('mobile-menu-toggle')?.addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu?.classList.toggle('hidden');
  });

  
  document.getElementById('search-toggle')?.addEventListener('click', function() {
    const searchBox = document.getElementById('search-box');
    searchBox?.classList.toggle('hidden');
    if (!searchBox?.classList.contains('hidden')) {
      searchBox?.querySelector('.search-input')?.focus();
    }
  });

  
  document.getElementById('search-toggle-mobile')?.addEventListener('click', function() {
    const searchBoxMobile = document.getElementById('search-box-mobile');
    searchBoxMobile?.classList.toggle('hidden');
    if (!searchBoxMobile?.classList.contains('hidden')) {
      searchBoxMobile?.querySelector('.search-input')?.focus();
    }
  });

  
  document.addEventListener('click', function(e) {
    const searchBox = document.getElementById('search-box');
    const searchToggle = document.getElementById('search-toggle');
    if (searchBox && searchToggle && !searchBox.contains(e.target) && !searchToggle.contains(e.target)) {
      searchBox.classList.add('hidden');
    }
  });

  
  document.addEventListener('click', function(e) {
    const searchBoxMobile = document.getElementById('search-box-mobile');
    const searchToggleMobile = document.getElementById('search-toggle-mobile');
    if (searchBoxMobile && searchToggleMobile && !searchBoxMobile.contains(e.target) && !searchToggleMobile.contains(e.target)) {
      searchBoxMobile.classList.add('hidden');
    }
  });
</script>


  <main class="flex-grow">
    
<article class="container mx-auto px-4 sm:px-6 md:px-4 py-8 sm:py-10 md:py-12">
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-[75%_25%] gap-8">
      
      <div class="min-w-0">
        
        <header class="mb-8">
          
          <nav class="text-xs sm:text-sm mb-4">
            <ol class="flex items-center space-x-2 text-gray-600 dark:text-dark-text-secondary">
              <li><a href="https://ravichaganti.com/" class="hover:text-primary dark:hover:text-blue-400">Home</a></li>
              <li><span class="mx-2">/</span></li>
              <li><a href="/blog/" class="hover:text-primary dark:hover:text-blue-400">Blog</a></li>
              
              <li><span class="mx-2">/</span></li>
              <li><a href="/categories/google/" class="hover:text-primary dark:hover:text-blue-400">Google</a></li>
              
            </ol>
          </nav>

          
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-dark-text mb-6">
            Google ADK - Callbacks
          </h1>

          
          <div
            class="flex flex-wrap items-center gap-2 sm:gap-3 md:gap-4 text-sm sm:text-base text-gray-600 dark:text-dark-text-secondary mb-6">
            
            <div class="flex items-center">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <time datetime=" 2025-12-12">December 12, 2025</time>
            </div>

            
            
            <span>•</span>
            <div class="flex items-center">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>18 min read</span>
            </div>
            

            
            
          </div>

          
          <div class="flex flex-wrap gap-2 mb-6">
            
            
            <a href="/categories/google/"
              class="inline-block px-3 py-1 text-sm font-medium bg-primary/10 dark:bg-primary/20 text-primary dark:text-blue-400 rounded-full hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors no-underline">
              Google
            </a>
            
            <a href="/categories/agent-development-kit/"
              class="inline-block px-3 py-1 text-sm font-medium bg-primary/10 dark:bg-primary/20 text-primary dark:text-blue-400 rounded-full hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors no-underline">
              Agent Development Kit
            </a>
            
            <a href="/categories/agents/"
              class="inline-block px-3 py-1 text-sm font-medium bg-primary/10 dark:bg-primary/20 text-primary dark:text-blue-400 rounded-full hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors no-underline">
              Agents
            </a>
            
            
            
            
            <a href="/series/google-adk/"
              class="inline-block px-3 py-1 text-sm font-medium bg-secondary/10 dark:bg-secondary/20 text-secondary dark:text-purple-400 rounded-full hover:bg-secondary/20 dark:hover:bg-secondary/30 transition-colors no-underline">
              📚 Series: Google ADK
            </a>
            
            
          </div>

          
          
          <div
            class="text-base sm:text-lg md:text-xl text-gray-700 dark:text-dark-text-secondary italic border-l-4 border-primary dark:border-blue-400 pl-4 sm:pl-6 py-2 mb-6 sm:mb-8 bg-gray-50 dark:bg-dark-bg-tertiary rounded-r">
            Callbacks are user-defined functions that hook into an agent&#39;s execution pipeline at predefined checkpoints. They let you observe, customize, and control agent behavior without modifying the ADK framework code.
          </div>
          
        </header>

        
        


  
  
  
    <aside class="bg-gradient-to-br from-secondary/5 to-primary/5 dark:from-secondary/10 dark:to-primary/10 rounded-lg shadow-md dark:shadow-2xl dark:shadow-black/20 p-4 mb-6 border border-secondary/20 dark:border-secondary/30">
      
      <button
        class="flex items-center justify-between w-full text-left font-semibold text-base text-gray-900 dark:text-dark-text hover:text-secondary dark:hover:text-purple-400 transition-colors"
        aria-expanded="false"
        aria-controls="series-content"
      >
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
          </svg>
          Series: Google ADK
        </span>
        <svg
          id="series-chevron"
          class="w-4 h-4 transform transition-transform -rotate-90"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>

      
      <p class="text-xs text-gray-600 dark:text-dark-text-secondary mt-2 mb-2 collapsed" id="series-description">
        Part of a 7-part series
      </p>

      
      <nav id="series-content" class="series-content collapsed mt-1">
        <ol class="space-y-3">
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                1
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/introduction-to-google-agent-development-kit/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Introduction to Google Agent Development Kit
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Dec 1, 2025</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                2
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/google-adk-types-of-agents/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Google ADK - types of agents
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Dec 3, 2025</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                3
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Google ADK - Sessions, state, and memory
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Dec 5, 2025</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                4
              </span>
              <div class="flex-grow">
                
                  <span class="font-bold text-secondary dark:text-purple-400">
                    Google ADK - Callbacks
                    <span class="text-xs ml-2 px-2 py-0.5 bg-secondary dark:bg-purple-600 text-white rounded">You are here</span>
                  </span>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Dec 12, 2025</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                5
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/google-adk-runner-and-execution-architecture/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Google ADK - Runner and execution architecture
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Dec 18, 2025</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                6
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/building-a-multi-agent-linkedin-newsletter-system-with-google-adk/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Building a Multi-Agent LinkedIn Newsletter System with Google ADK
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Jan 26, 2026</p>
              </div>
            </li>
          
            <li class="flex items-start">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-secondary/20 dark:bg-secondary/30 text-secondary dark:text-purple-400 flex items-center justify-center text-xs font-bold mr-3 mt-0.5">
                7
              </span>
              <div class="flex-grow">
                
                  <a href="https://ravichaganti.com/blog/building-multi-agent-systems-with-google-adk-and-the-a2a-protocol/" class="text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline hover:underline">
                    Building multi-agent systems with Google ADK and the A2A protocol
                  </a>
                
                <p class="text-xs text-gray-500 dark:text-dark-text-muted mt-1">Jan 27, 2026</p>
              </div>
            </li>
          
        </ol>

        
        <div class="mt-6 pt-6 border-t border-secondary/20 dark:border-secondary/30 grid grid-cols-2 gap-4">
          
          
            
          
            
          
            
          
            
              
            
          
            
          
            
          
            
          

          
          
            
            <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/" class="flex items-center text-sm text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline group">
              <svg class="w-4 h-4 mr-1 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              <span class="truncate">Google ADK - Sessions, state, and memory</span>
            </a>
          

          
          
            
            <a href="https://ravichaganti.com/blog/google-adk-runner-and-execution-architecture/" class="flex items-center justify-end text-sm text-gray-700 dark:text-dark-text-secondary hover:text-secondary dark:hover:text-purple-400 transition-colors no-underline group">
              <span class="truncate">Google ADK - Runner and execution architecture</span>
              <svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </a>
          
        </div>
      </nav>
    </aside>
  



        
        <div class="block lg:hidden mobile-toc-container">
          

  
    <div class="bg-white dark:bg-dark-bg-secondary rounded-lg shadow-md dark:shadow-2xl dark:shadow-black/20 p-4 mb-6 border border-gray-200 dark:border-dark-border">
      
      <button
        class="flex items-center justify-between w-full text-left font-semibold text-base text-gray-900 dark:text-dark-text hover:text-primary dark:hover:text-blue-400 transition-colors"
        aria-expanded="false"
        aria-controls="toc-content"
      >
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
          </svg>
          Table of Contents
        </span>
        <svg
          id="toc-chevron"
          class="w-4 h-4 transform transition-transform -rotate-90"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>

      
      <nav id="toc-content" class="toc-content collapsed text-sm mt-3">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#callbacks">Callbacks</a>
      <ul>
        <li><a href="#agent-lifecycle-callbacks">Agent lifecycle callbacks</a></li>
        <li><a href="#model-interaction-callbacks">Model interaction callbacks</a></li>
        <li><a href="#tool-execution-callbacks">Tool execution callbacks</a></li>
        <li><a href="#callbackcontext">CallbackContext</a></li>
        <li><a href="#toolcontext">ToolContext</a></li>
        <li><a href="#state-prefixes-in-callbacks">State prefixes in callbacks</a></li>
        <li><a href="#registering-callbacks">Registering callbacks</a></li>
      </ul>
    </li>
    <li><a href="#observability-logging">Observability logging</a></li>
    <li><a href="#input-guardrails">Input guardrails</a></li>
    <li><a href="#output-sanitization">Output sanitization</a></li>
    <li><a href="#tool-authorization">Tool authorization</a></li>
    <li><a href="#response-caching">Response caching</a></li>
    <li><a href="#dynamic-instruction-injection">Dynamic instruction injection</a></li>
    <li><a href="#artifact-handling-in-callbacks">Artifact handling in callbacks</a></li>
    <li><a href="#putting-it-all-together">Putting it all together</a></li>
  </ul>
</nav>
      </nav>
    </div>

    <style>
      #toc-content ul {
        list-style: none;
        padding-left: 1rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }
      #toc-content > nav > ul {
        padding-left: 0;
      }
      #toc-content li {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }
      #toc-content a {
        color: #374151;
        text-decoration: none;
        transition: color 0.2s;
      }
      #toc-content a:hover {
        color: #1e40af;
        text-decoration: underline;
      }
       
      .dark #toc-content a {
        color: #cbd5e1;
      }
      .dark #toc-content a:hover {
        color: #60a5fa;
      }
    </style>
  


        </div>

        <style>
          @media (min-width: 1024px) {
            .mobile-toc-container {
              display: none !important;
            }

             
            html,
            body,
            main,
            article,
            .container,
            .max-w-7xl,
            .grid,
            aside {
              overflow: visible !important;
              height: auto !important;
            }

             
            .sidebar-sticky-reinforced {
              position: -webkit-sticky !important;
              position: sticky !important;
              top: 130px !important;
              z-index: 100;
              align-self: start;
              height: fit-content;
            }
          }
        </style>

        
        <div class="prose prose-sm sm:prose-base md:prose-lg max-w-none mb-8 sm:mb-10 md:mb-12">
          <p>Imagine you built a customer support agent. It works well, but you then discover that the LLM occasionally leaks email addresses in its responses. You need to sanitize output before the user sees it. Or consider a flight booking agent where only admin users should be allowed to cancel reservations. You need to check permissions before a tool executes. Or maybe the same question is asked a hundred times a day, and each time you are paying for an LLM API call. You need to return cached responses and skip the model entirely. All of these share a common pattern. You need to run your code at specific points in the agent&rsquo;s execution pipeline, before or after the model call, before or after a tool runs, before or after the agent itself. This is where the callbacks feature comes into play.</p>
<h2 id="callbacks">Callbacks</h2>
<p>Callbacks are user-defined functions that hook into an agent&rsquo;s execution pipeline at predefined checkpoints. You define them, attach them to an agent at creation time, and ADK calls them automatically at key stages. They let you observe, customize, and control behavior without modifying any ADK framework code. Think of them as checkpoints during the agent&rsquo;s process.</p>
<p>The core mental model is a pipeline with six interception points grouped into three pairs.</p>
<p><figure class="figure " style="max-width: 50%; height: 50%; margin: 1.5rem auto;">
  <a href="/images/adk-callbacks.png" class="glightbox" data-gallery="post-images" data-glightbox="description: " style="display: block; height: 100%;">
    <img src="/images/adk-callbacks.png" alt="" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
  </a></figure>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  
  
  <script src="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/js/glightbox.min.js"></script>
  
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const lightbox = GLightbox({
        selector: '.glightbox',
        touchNavigation: true,
        loop: true,
        autoplayVideos: true,
        zoomable: true,
        draggable: true,
        closeButton: true,
        moreLength: 0
      });
    });
  </script></p>
<ul>
<li>The agent lifecycle pair (<code>before_agent_callback</code> and <code>after_agent_callback</code>) wraps the entire agent execution.</li>
<li>The model interaction pair (<code>before_model_callback</code> and <code>after_model_callback</code>) wraps the LLM API call.</li>
<li>The tool execution pair (<code>before_tool_callback</code> and <code>after_tool_callback</code>) wraps each tool invocation.</li>
</ul>
<p>Every <code>before_*</code> callback acts as a gatekeeper. These callbacks return <code>None</code> to proceed to the next step, or return a specific object to skip the step and use that object as the output instead.</p>
<p>Every <code>after_*</code> callback acts as a post-processor. Return <code>None</code> to pass through the original result, or return a specific object to replace it.</p>
<p>These agent lifecycle callbacks are available on all agent types (<code>BaseAgent</code>, <code>LlmAgent</code>, <code>SequentialAgent</code>, <code>ParallelAgent</code>, <code>LoopAgent</code>). The model and tool callbacks are specific to <code>LlmAgent</code>. These callbacks are normal Python functions with specific parameters and return types.</p>
<h3 id="agent-lifecycle-callbacks">Agent lifecycle callbacks</h3>
<p>The agent lifecycle callbacks are available before the agent starts work and after it finishes.</p>
<p>The <code>before_agent_callback</code> is useful for setting up the environment needed for the agent&rsquo;s run. You can use this callback validate session state or even modify the invocation context before the agent&rsquo;s core logic starts.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_before_agent</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Runner</code> invokes this function and provides a <code>CallbackContext</code> object as input. This object contains information about the agent&rsquo;s current execution state, session state, and other references such as artifacts and memory.</p>
<p>The <code>after_agent_callback</code> is useful for cleaning up after the agent run, performing post-execution checks, or modifying or augmenting the agent&rsquo;s final output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_after_agent</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="model-interaction-callbacks">Model interaction callbacks</h3>
<p>The model interaction callbacks are specific to <code>LlmAgent</code> and wrap the LLM API calls.</p>
<p>The <code>before_model_callback</code> is useful when you want to inspect or modify the request to the LLM API. For example, you can implement use cases such as adding a few-shot examples to the prompt sent to the LLM, implementing input guardrails, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_before_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>LlmRequest</code> parameter is mutable. You can modify it in-place to change what the LLM receives.</p>
<p>The <code>after_model_callback</code> is useful when you want to inspect or modify LLM generated response. With this callback, you can implement response reformatting, such as removing sensitive information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_after_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_response</span><span class="p">:</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>LlmResponse</code> object in the <code>after_model_callback</code> contains LLM generated response. Both agent lifecycle and model interaction callback pairs receive <code>CallbackContext</code> as input.</p>
<h3 id="tool-execution-callbacks">Tool execution callbacks</h3>
<p>The <code>tool_execution_callback</code> is also specific to <code>LlmAgent</code> and wraps each individual tool invocation that the LLM might request.</p>
<p>The <code>before_tool_callback</code> is useful when you want to determine whether tool execution should be allowed, inspect or modify tool arguments, or implement tool-level caching.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_before_tool</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>args</code> parameter is mutable. We can modify it in-place to change what the tool receives, then return <code>None</code> to invoke the tool with the modified arguments.</p>
<p>The <code>after_tool_callback</code> is useful for scenarios such as inspecting or modifying tool output before sending it to the LLM, and for logging tool results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">my_after_tool</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool_response</span><span class="p">:</span> <span class="n">Dict</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As seen so far, every callback receives a context object that provides access to the agent&rsquo;s session state, artifacts, and invocation metadata. There are two types of context, and understanding them is essential.</p>
<h3 id="callbackcontext">CallbackContext</h3>
<p><code>CallbackContext</code> is used in agent lifecycle and model interaction callbacks. It provides access to the agent name, the invocation ID, and the session state.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Properties available:</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span>      <span class="c1"># Name of the current agent</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">invocation_id</span>   <span class="c1"># Unique ID for this invocation</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span>           <span class="c1"># Session state (read/write)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># State modifications are automatically tracked</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;my_key&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;my_value&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">current</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;my_key&#34;</span><span class="p">,</span> <span class="s2">&#34;default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Artifact operations:</span>
</span></span><span class="line"><span class="cl"><span class="n">version</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">save_artifact</span><span class="p">(</span><span class="s2">&#34;filename.txt&#34;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;content&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">part</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">load_artifact</span><span class="p">(</span><span class="s2">&#34;filename.txt&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When you write <code>callback_context.state[&quot;key&quot;] = value</code>, the framework automatically captures this into <code>EventActions.state_delta</code>, which the <code>SessionService</code> processes via <code>append_event</code>. This is the same mechanism described in the article on <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/">sessions, state, and memory</a>. You never need to manually construct events or call <code>append_event</code> inside callbacks.</p>
<h3 id="toolcontext">ToolContext</h3>
<p><code>ToolContext</code> is used in tool callbacks. It extends <code>CallbackContext</code> with tool-specific capabilities.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.tools.tool_context</span> <span class="kn">import</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Everything from CallbackContext PLUS:</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_context</span><span class="o">.</span><span class="n">function_call_id</span>    <span class="c1"># ID linking to the LLM&#39;s function call</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_context</span><span class="o">.</span><span class="n">actions</span>             <span class="c1"># Direct access to EventActions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Authentication:</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_context</span><span class="o">.</span><span class="n">request_credential</span><span class="p">(</span><span class="n">auth_config</span><span class="p">)</span>   <span class="c1"># Trigger OAuth flow</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_context</span><span class="o">.</span><span class="n">get_auth_response</span><span class="p">(</span><span class="n">auth_config</span><span class="p">)</span>    <span class="c1"># Retrieve credentials</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Memory &amp; Artifacts:</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">search_memory</span><span class="p">(</span><span class="s2">&#34;query&#34;</span><span class="p">)</span>  <span class="c1"># Search memory service</span>
</span></span><span class="line"><span class="cl"><span class="n">artifacts</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">list_artifacts</span><span class="p">()</span>       <span class="c1"># List available artifacts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Summarization control:</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_context</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">skip_summarization</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Skip LLM summarization of tool result</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="state-prefixes-in-callbacks">State prefixes in callbacks</h3>
<p>State keys in callbacks use the same prefix scoping system described in the <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/">sessions, state, and memory</a> article.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Application-wide state (shared across all users/sessions)</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;app:global_config&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;max_retries&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># User-specific state (shared across sessions for this user)</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;user:preferences&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;language&#34;</span><span class="p">:</span> <span class="s2">&#34;es&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Temporary state (cleared between invocations)</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;temp:current_step&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;processing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># No prefix = session-scoped (default, persists within session)</span>
</span></span><span class="line"><span class="cl"><span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;conversation_topic&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;weather&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="registering-callbacks">Registering callbacks</h3>
<p>You register callbacks by passing them as parameters when creating an agent. Here is an example that registers all six callbacks on an <code>LlmAgent</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents</span> <span class="kn">import</span> <span class="n">LlmAgent</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">agent</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;MyAgent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gemini-2.0-flash&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">instruction</span><span class="o">=</span><span class="s2">&#34;You are a helpful assistant.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">my_tool</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_agent_callback</span><span class="o">=</span><span class="n">my_before_agent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_agent_callback</span><span class="o">=</span><span class="n">my_after_agent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_model_callback</span><span class="o">=</span><span class="n">my_before_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_model_callback</span><span class="o">=</span><span class="n">my_after_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_tool_callback</span><span class="o">=</span><span class="n">my_before_tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_tool_callback</span><span class="o">=</span><span class="n">my_after_tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can also pass a list of callbacks. When a list is provided, the callbacks execute sequentially. The first callback that returns a non-<code>None</code> value stops the chain, and subsequent callbacks in the list do not execute.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agent</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;ProductionAgent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gemini-2.0-flash&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">instruction</span><span class="o">=</span><span class="s2">&#34;You are helpful.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_model_callback</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">check_cache</span><span class="p">,</span>       <span class="c1"># Returns LlmResponse if cache hit</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_guardrail</span><span class="p">,</span> <span class="c1"># Returns LlmResponse if policy violation</span>
</span></span><span class="line"><span class="cl">        <span class="n">inject_context</span><span class="p">,</span>    <span class="c1"># Modifies request, returns None</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_request</span><span class="p">,</span>       <span class="c1"># Logs, returns None</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this example, if <code>check_cache</code> finds a cache hit, it returns an <code>LlmResponse</code>, and the remaining three callbacks are skipped entirely. Callbacks can be either synchronous or asynchronous functions.</p>
<p>For workflow agents (<code>SequentialAgent</code>, <code>ParallelAgent</code>, <code>LoopAgent</code>), only agent lifecycle callbacks (<code>before_agent_callback</code> and <code>after_agent_callback</code>) are available, since these agents do not interact directly with an LLM or tools.</p>
<p>With the basics out of the way, let us look at some sample use cases.</p>
<h2 id="observability-logging">Observability logging</h2>
<p>The simplest use of callbacks is logging. Every callback returns <code>None</code>, so the agent&rsquo;s behavior is unaffected. This provides a complete picture of the agent&rsquo;s execution for debugging and monitoring.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents</span> <span class="kn">import</span> <span class="n">LlmAgent</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span><span class="p">,</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.genai</span> <span class="kn">import</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_before_agent</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">] Agent starting - invocation: </span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">invocation_id</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_after_agent</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">] Agent completed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_before_model</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">] Sending </span><span class="si">{</span><span class="n">msg_count</span><span class="si">}</span><span class="s2"> messages to LLM&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_after_model</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_response</span><span class="p">:</span> <span class="n">LlmResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">has_tool_calls</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">part</span><span class="o">.</span><span class="n">function_call</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">(</span><span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span> <span class="ow">or</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">] LLM responded (tool_calls=</span><span class="si">{</span><span class="n">has_tool_calls</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_before_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Executing with args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_after_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">,</span> <span class="n">tool_response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] Returned: </span><span class="si">{</span><span class="n">tool_response</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">agent</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;ObservableAgent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gemini-2.0-flash&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">instruction</span><span class="o">=</span><span class="s2">&#34;You are a helpful assistant.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_agent_callback</span><span class="o">=</span><span class="n">log_before_agent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_agent_callback</span><span class="o">=</span><span class="n">log_after_agent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_model_callback</span><span class="o">=</span><span class="n">log_before_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_model_callback</span><span class="o">=</span><span class="n">log_after_model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_tool_callback</span><span class="o">=</span><span class="n">log_before_tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">after_tool_callback</span><span class="o">=</span><span class="n">log_after_tool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Every callback returns <code>None</code>, so the agent operates exactly as it would without callbacks. The logs give you a complete trace of what happened and when.</p>
<h2 id="input-guardrails">Input guardrails</h2>
<p>A common requirement is to block prompts containing forbidden content before they reach the LLM. The <code>before_model_callback</code> is the natural place for this, as it fires just before the LLM API call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents</span> <span class="kn">import</span> <span class="n">LlmAgent</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span><span class="p">,</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.genai</span> <span class="kn">import</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BLOCKED_KEYWORDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;hack&#34;</span><span class="p">,</span> <span class="s2">&#34;exploit&#34;</span><span class="p">,</span> <span class="s2">&#34;bypass security&#34;</span><span class="p">,</span> <span class="s2">&#34;illegal&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">content_guardrail</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Block requests containing forbidden keywords.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">all_text</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">BLOCKED_KEYWORDS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">all_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;temp:last_violation&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyword</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;user:violation_count&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:violation_count&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">role</span><span class="o">=</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">text</span><span class="o">=</span><span class="s2">&#34;I&#39;m unable to help with that request. &#34;</span>
</span></span><span class="line"><span class="cl">                             <span class="s2">&#34;It appears to involve content that violates our usage policy.&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">agent</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;GuardedAgent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gemini-2.0-flash&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">instruction</span><span class="o">=</span><span class="s2">&#34;You are a helpful assistant.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_model_callback</span><span class="o">=</span><span class="n">content_guardrail</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When a blocked keyword is detected, the callback returns an <code>LlmResponse</code> directly. This skips the LLM call entirely; the user sees the policy message, and you pay no API call cost. The violation is tracked using the <code>temp:</code> prefix for the current invocation and the <code>user:</code> prefix for persistent tracking across sessions.</p>
<h2 id="output-sanitization">Output sanitization</h2>
<p>After the LLM responds, you may need to clean its output before the user sees it. The <code>after_model_callback</code> lets you inspect and modify the LLM&rsquo;s response.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">EMAIL_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">PHONE_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\b(\+?1[-.\s]?)?\(?\d</span><span class="si">{3}</span><span class="s1">\)?[-.\s]?\d</span><span class="si">{3}</span><span class="s1">[-.\s]?\d</span><span class="si">{4}</span><span class="s1">\b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sanitize_llm_output</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_response</span><span class="p">:</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Redact PII from model responses.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_parts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">function_call</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_text</span> <span class="o">=</span> <span class="n">EMAIL_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;[EMAIL REDACTED]&#34;</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_text</span> <span class="o">=</span> <span class="n">PHONE_PATTERN</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;[PHONE REDACTED]&#34;</span><span class="p">,</span> <span class="n">new_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">new_text</span> <span class="o">!=</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">new_text</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">modified</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_response</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">llm_response</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span> <span class="o">=</span> <span class="n">new_parts</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new_response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is an important detail here. The callback checks for <code>part.function_call</code> and skips those parts. If your <code>after_model_callback</code> modifies function call responses, it breaks tool execution. Always check for function calls first and pass them through unchanged. Also note the use of <code>deepcopy</code> when building a modified <code>LlmResponse</code> to avoid corrupting the original if other callbacks need it.</p>
<h2 id="tool-authorization">Tool authorization</h2>
<p>The <code>before_tool_callback</code> lets you enforce access control before a tool executes. This is important for tools that perform destructive operations, such as deleting records or cancelling bookings.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TOOL_PERMISSIONS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;delete_record&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;admin&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;cancel_booking&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="s2">&#34;manager&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;search_flights&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="s2">&#34;manager&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">authorize_tool_usage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Check user role before allowing tool execution.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_role</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:role&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_roles</span> <span class="o">=</span> <span class="n">TOOL_PERMISSIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;admin&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user_role</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_roles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;Access denied. Tool &#39;</span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; requires one of </span><span class="si">{</span><span class="n">allowed_roles</span><span class="si">}</span><span class="s2">. &#34;</span>
</span></span><span class="line"><span class="cl">                     <span class="sa">f</span><span class="s2">&#34;Your role: &#39;</span><span class="si">{</span><span class="n">user_role</span><span class="si">}</span><span class="s2">&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For this to work, the <code>user:role</code> must be set in the session state when the session is created. Because the key uses the <code>user:</code> prefix, it persists across sessions for that user within the same application.</p>
<h2 id="response-caching">Response caching</h2>
<p>Response caching is a powerful pattern that uses a <code>before_model_callback</code> and <code>after_model_callback</code> pair working together. The <code>before</code> callback checks the cache and returns a stored response if found (skipping the LLM call). The <code>after</code> callback stores new responses in the cache.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span><span class="p">,</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_cache_key</span><span class="p">(</span><span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_msg</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span> <span class="ow">and</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_msg</span> <span class="o">=</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;temp:cache:</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">last_msg</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check_cache_before_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return cached response if available.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">_cache_key</span><span class="p">(</span><span class="n">llm_request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cached</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cached</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&#34;model&#34;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">cached</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">store_cache_after_model</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_response</span><span class="p">:</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Cache the response for future use.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;temp:cache:</span><span class="si">{</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The cache key uses the <code>temp:</code> prefix because cached responses are only relevant within the current invocation. If you want responses to persist across invocations, use a session-scoped key (no prefix) instead.</p>
<h2 id="dynamic-instruction-injection">Dynamic instruction injection</h2>
<p>One of the most practical callback patterns is dynamically modifying the agent&rsquo;s system instructions based on state. The <code>before_model_callback</code> can modify the <code>llm_request</code> in-place to inject context that the LLM would not otherwise have.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span><span class="p">,</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.genai</span> <span class="kn">import</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">inject_user_context</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Dynamically inject user context into the system instruction.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_lang</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:language&#34;</span><span class="p">,</span> <span class="s2">&#34;English&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_tier</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:tier&#34;</span><span class="p">,</span> <span class="s2">&#34;free&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">conversation_count</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:conversation_count&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">additions</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user_lang</span> <span class="o">!=</span> <span class="s2">&#34;English&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Respond in </span><span class="si">{</span><span class="n">user_lang</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user_tier</span> <span class="o">==</span> <span class="s2">&#34;premium&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;This is a premium user. Provide detailed, comprehensive answers.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;This is a free-tier user. Keep responses concise.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">conversation_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">additions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;This is the user&#39;s first conversation. Be welcoming.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">context_text</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">additions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">current_instruction</span> <span class="o">=</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system_instruction</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">current_instruction</span> <span class="ow">and</span> <span class="n">current_instruction</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">original_text</span> <span class="o">=</span> <span class="n">current_instruction</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_instruction</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">original_text</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">context_text</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">llm_request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">system_instruction</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">role</span><span class="o">=</span><span class="s2">&#34;system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">context_text</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;user:conversation_count&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversation_count</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This callback modifies the <code>llm_request</code> in-place and returns <code>None</code>, so the LLM call proceeds normally but with enriched instructions. Note that ADK also provides simpler alternatives for instruction injection using <code>{key}</code> template syntax directly in agent instructions, as described in the <a href="/blog/google-adk-sessions-state-and-memory">sessions, state, and memory</a> article. Use the callback approach when you need conditional logic that goes beyond simple value substitution.</p>
<h2 id="artifact-handling-in-callbacks">Artifact handling in callbacks</h2>
<p>Callbacks can save and load artifacts, which are files or data blobs stored alongside the session. This is useful for persisting generated content, such as reports or processed results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.genai</span> <span class="kn">import</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_report_artifact</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">llm_response</span><span class="p">:</span> <span class="n">LlmResponse</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Save long model responses as downloadable artifacts.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">llm_response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">callback_context</span><span class="o">.</span><span class="n">save_artifact</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;generated_report.md&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;artifact&#34;</span><span class="p">:</span> <span class="s2">&#34;generated_report.md&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;length&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;agent&#34;</span><span class="p">:</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">callback_context</span><span class="o">.</span><span class="n">save_artifact</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;report_metadata.json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="putting-it-all-together">Putting it all together</h2>
<p>Here is a complete example that combines multiple callback patterns into a production-ready agent. This agent uses guardrails, caching, tool authorization, and logging.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents</span> <span class="kn">import</span> <span class="n">LlmAgent</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.agents.callback_context</span> <span class="kn">import</span> <span class="n">CallbackContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.models</span> <span class="kn">import</span> <span class="n">LlmResponse</span><span class="p">,</span> <span class="n">LlmRequest</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.tools</span> <span class="kn">import</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">ToolContext</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.sessions</span> <span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.adk.runners</span> <span class="kn">import</span> <span class="n">Runner</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">google.genai</span> <span class="kn">import</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BLOCKED_KEYWORDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;hack&#34;</span><span class="p">,</span> <span class="s2">&#34;exploit&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Callbacks ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">guardrail</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">part</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">BLOCKED_KEYWORDS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">all_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;user:violations&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:violations&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">role</span><span class="o">=</span><span class="s2">&#34;model&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Request blocked by policy.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_model_call</span><span class="p">(</span><span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[</span><span class="si">{</span><span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">] LLM call with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">authorize_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">role</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;user:role&#34;</span><span class="p">,</span> <span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;delete_booking&#34;</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">!=</span> <span class="s2">&#34;admin&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Admin access required for deletion&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">log_tool_call</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">] args=</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Tools ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">search_bookings</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Search for existing bookings.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&#34;last_search&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;bookings&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;BK001&#34;</span><span class="p">,</span> <span class="s2">&#34;flight&#34;</span><span class="p">:</span> <span class="s2">&#34;AA101&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;confirmed&#34;</span><span class="p">}]}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete_booking</span><span class="p">(</span><span class="n">booking_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Delete a booking by ID. Admin only.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;deleted&#34;</span><span class="p">,</span> <span class="s2">&#34;booking_id&#34;</span><span class="p">:</span> <span class="n">booking_id</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Agent ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">support_agent</span> <span class="o">=</span> <span class="n">LlmAgent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;SupportAgent&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gemini-2.0-flash&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">instruction</span><span class="o">=</span><span class="s2">&#34;You are a booking support agent. Help users search and manage bookings.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search_bookings</span><span class="p">,</span> <span class="n">delete_booking</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_model_callback</span><span class="o">=</span><span class="p">[</span><span class="n">guardrail</span><span class="p">,</span> <span class="n">log_model_call</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">before_tool_callback</span><span class="o">=</span><span class="p">[</span><span class="n">authorize_tool</span><span class="p">,</span> <span class="n">log_tool_call</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_key</span><span class="o">=</span><span class="s2">&#34;last_response&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># --- Run ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">agent</span><span class="o">=</span><span class="n">support_agent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_name</span><span class="o">=</span><span class="s2">&#34;support_app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_name</span><span class="o">=</span><span class="s2">&#34;support_app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;user1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;user:name&#34;</span><span class="p">:</span> <span class="s2">&#34;Ravi&#34;</span><span class="p">,</span> <span class="s2">&#34;user:role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Turn 1: Normal request</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg1</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Find my bookings&#34;</span><span class="p">)],</span> <span class="n">role</span><span class="o">=</span><span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;user1&#34;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">msg1</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">()</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Agent: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Turn 2: Attempt deletion without admin role</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg2</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Delete booking BK001&#34;</span><span class="p">)],</span> <span class="n">role</span><span class="o">=</span><span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;user1&#34;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">msg2</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">()</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Agent: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Turn 3: Blocked request</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg3</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&#34;Help me hack the system&#34;</span><span class="p">)],</span> <span class="n">role</span><span class="o">=</span><span class="s2">&#34;user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;user1&#34;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">msg3</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">()</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Agent: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Check state</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_name</span><span class="o">=</span><span class="s2">&#34;support_app&#34;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="s2">&#34;user1&#34;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Violations: </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user:violations&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When you run this, you can observe how the callback chain works in practice.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt; python.exe .<span class="se">\c</span>allbacks-demo.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Agent: OK. I found one booking with ID BK001 <span class="k">for</span> flight AA101. Is that correct?
</span></span><span class="line"><span class="cl">Agent: I am sorry, I <span class="k">do</span> not have the permission to delete this booking.
</span></span><span class="line"><span class="cl">Agent: Request blocked by policy.
</span></span><span class="line"><span class="cl">Violations: <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first request flows through normally. The guardrail finds no blocked keywords, logging fires, and the <code>search_bookings</code> tool executes. The second request attempts to use the <code>delete_booking</code> tool, but the <code>authorize_tool</code> callback blocks it because the user&rsquo;s role is <code>user</code>, not <code>admin</code>. The third request is blocked at the model level by the guardrail before the LLM is even called.</p>
<p>When writing callbacks, keep a few guidelines in mind. Each callback should do one thing. Compose multiple concerns using callback lists rather than building monolithic functions. Always wrap callback logic in <code>try/except</code>. A crashing callback can break the entire agent invocation. When in doubt, fail open (return <code>None</code>) and log the error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">safe_callback</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ... your logic ...</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Callback error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Callbacks execute synchronously in the agent&rsquo;s processing loop. Avoid blocking I/O or heavy computation in sync callbacks. Use async callbacks when making network calls. Use descriptive function names that convey purpose — <code>authorize_tool_usage</code> is better than <code>before_tool_cb</code>.</p>
<p>For state management within callbacks, use specific keys with appropriate prefixes (<code>app:</code>, <code>user:</code>, <code>temp:</code>). Changes are visible immediately within the current invocation and persisted at event processing time. The full mechanics of state scoping and persistence are described in the <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/">sessions, state, and memory</a> article.</p>
<p>There are also a few common pitfalls to be aware of. If your observation-only callback accidentally returns a value, it will override the step&rsquo;s behavior. When building a modified <code>LlmResponse</code> in <code>after_model_callback</code>, use <code>deepcopy</code> to avoid corrupting the original. If your <code>after_model_callback</code> modifies text responses, always check for <code>part.function_call</code> first and skip those — modifying function call responses breaks tool execution. And be careful with state key collisions when multiple callbacks write to the same key without coordination; use namespaced keys.</p>
<p>Understanding how callbacks integrate with the agent execution pipeline is essential for building production-ready agents. This article explored the six callback types, their signatures and return behavior, and demonstrated practical patterns from simple logging through input guardrails, output sanitization, tool authorization, response caching, and dynamic instruction injection. These patterns, combined with the session state management covered in the <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/">sessions, state, and memory</a> article, provide the building blocks for creating robust, observable, and customizable agent workflows. I recommend experimenting with these patterns in your own agents.</p>

        </div>

        
        

        
        

<div class="mt-12 pt-8 border-t border-gray-200 dark:border-dark-border">
  <h3 class="text-lg font-bold mb-4 text-center text-gray-900 dark:text-dark-text">Share this article</h3>
  <div class="flex flex-wrap justify-center items-center gap-3 sm:gap-4">
    
    <button onclick="shareNative()"
      class="sm:hidden w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-primary text-primary dark:border-blue-400 dark:text-blue-400 flex items-center justify-center transition-all shadow-sm hover:shadow-md hover:bg-primary hover:text-white dark:hover:bg-blue-600 dark:hover:text-white dark:hover:border-blue-600"
      aria-label="Share" title="Share" id="native-share-btn">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z">
        </path>
      </svg>
    </button>

    
    <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fravichaganti.com%2Fblog%2Fgoogle-adk-callbacks%2F&text=Google&#43;ADK&#43;-&#43;Callbacks"
      target="_blank" rel="noopener noreferrer"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-[#1DA1F2] text-[#1DA1F2] flex items-center justify-center transition-all no-underline shadow-sm hover:shadow-md hover:bg-[#1DA1F2] hover:text-white hover:scale-105"
      aria-label="Share on Twitter" title="Share on Twitter">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z" />
      </svg>
    </a>

    
    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fravichaganti.com%2Fblog%2Fgoogle-adk-callbacks%2F" target="_blank"
      rel="noopener noreferrer"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-[#0077B5] text-[#0077B5] flex items-center justify-center transition-all no-underline shadow-sm hover:shadow-md hover:bg-[#0077B5] hover:text-white hover:scale-105"
      aria-label="Share on LinkedIn" title="Share on LinkedIn">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
      </svg>
    </a>

    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fravichaganti.com%2Fblog%2Fgoogle-adk-callbacks%2F" target="_blank"
      rel="noopener noreferrer"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-[#1877F2] text-[#1877F2] flex items-center justify-center transition-all no-underline shadow-sm hover:shadow-md hover:bg-[#1877F2] hover:text-white hover:scale-105"
      aria-label="Share on Facebook" title="Share on Facebook">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" />
      </svg>
    </a>

    
    <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fravichaganti.com%2Fblog%2Fgoogle-adk-callbacks%2F&title=Google&#43;ADK&#43;-&#43;Callbacks"
      target="_blank" rel="noopener noreferrer"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-[#FF4500] text-[#FF4500] flex items-center justify-center transition-all no-underline shadow-sm hover:shadow-md hover:bg-[#FF4500] hover:text-white hover:scale-105"
      aria-label="Share on Reddit" title="Share on Reddit">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z" />
      </svg>
    </a>

    
    <a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fravichaganti.com%2Fblog%2Fgoogle-adk-callbacks%2F&t=Google&#43;ADK&#43;-&#43;Callbacks"
      target="_blank" rel="noopener noreferrer"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-[#FF6600] text-[#FF6600] flex items-center justify-center transition-all no-underline shadow-sm hover:shadow-md hover:bg-[#FF6600] hover:text-white hover:scale-105"
      aria-label="Share on Hacker News" title="Share on Hacker News">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path d="M0 0v24h24V0H0zm12.8 13.4v5.2H11v-5.2L6.6 5.4h2.1l3.3 6.2 3.3-6.2h2.1l-4.6 8z" />
      </svg>
    </a>

    
    <button onclick="copyToClipboard('https:\/\/ravichaganti.com\/blog\/google-adk-callbacks\/')"
      class="w-12 h-12 rounded-full bg-white dark:bg-dark-bg-secondary border-2 border-amber-500 text-amber-500 flex items-center justify-center transition-all shadow-sm hover:shadow-md hover:bg-amber-500 hover:text-white hover:scale-105"
      aria-label="Copy link" title="Copy link" id="copy-link-btn">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
        </path>
      </svg>
    </button>
  </div>
</div>

<script>
  
  function shareNative() {
    if (navigator.share) {
      navigator.share({
        title: 'Google ADK - Callbacks',
        text: 'Callbacks are user-defined functions that hook into an agent\u0027s execution pipeline at predefined checkpoints. They let you observe, customize, and control agent behavior without modifying the ADK framework code.',
        url: 'https:\/\/ravichaganti.com\/blog\/google-adk-callbacks\/'
      }).catch(function (error) {
        console.log('Error sharing:', error);
      });
    }
  }

  
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function () {
      const btn = document.getElementById('copy-link-btn');
      const originalHTML = btn.innerHTML;
      const originalTitle = btn.title;

      
      btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
      btn.title = 'Copied!';

      
      setTimeout(function () {
        btn.innerHTML = originalHTML;
        btn.title = originalTitle;
      }, 2000);
    }).catch(function (error) {
      console.error('Failed to copy:', error);
      alert('Failed to copy link. Please copy manually: ' + text);
    });
  }
</script>


        
        
<nav class="mt-12 pt-8 border-t border-gray-200 dark:border-dark-border" aria-label="Post navigation">
  
  
  
  

  
  
  
    
    
    

    
    
    

    
    
    
      
    
      
    
      
    
      
        
      
    
      
    
      
    
      
    

    
    
      
        
        
      
      
        
        
      
    
  

  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    
    <div class="flex">
      
        <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/"
           class="flex-1 group card hover:shadow-xl transition-all hover:scale-[1.02] no-underline"
           aria-label="Previous in Google ADK: Google ADK - Sessions, state, and memory">
          <div class="flex items-start gap-3">
            
            <div class="flex-shrink-0 text-primary dark:text-blue-400 group-hover:text-secondary dark:group-hover:text-purple-400 transition-colors mt-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </div>

            
            <div class="flex-1 min-w-0">
              <p class="text-xs text-gray-500 dark:text-dark-text-muted mb-1 uppercase tracking-wide">Previous in Google ADK</p>
              <h3 class="text-base font-bold text-gray-900 dark:text-dark-text mb-2 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                Google ADK - Sessions, state, and memory
              </h3>
              
                <p class="text-sm text-gray-600 dark:text-dark-text-secondary line-clamp-2">LLMs are stateless. Every API call to an LLM is independent. The model does not inherently remember what was said before. Yet meaningful conversations are inherently multi-turn, contextual, and stateful.</p>
              
            </div>
          </div>
        </a>
      
    </div>

    
    <div class="flex">
      
        <a href="https://ravichaganti.com/blog/google-adk-runner-and-execution-architecture/"
           class="flex-1 group card hover:shadow-xl transition-all hover:scale-[1.02] no-underline"
           aria-label="Next in Google ADK: Google ADK - Runner and execution architecture">
          <div class="flex items-start gap-3">
            
            <div class="flex-1 min-w-0 text-right md:text-left md:order-1">
              <p class="text-xs text-gray-500 dark:text-dark-text-muted mb-1 uppercase tracking-wide">Next in Google ADK</p>
              <h3 class="text-base font-bold text-gray-900 dark:text-dark-text mb-2 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                Google ADK - Runner and execution architecture
              </h3>
              
                <p class="text-sm text-gray-600 dark:text-dark-text-secondary line-clamp-2">You have agents, tools, callbacks, and sessions. But what actually runs them? The Runner is the central orchestrator that powers every agent interaction in Google ADK, driving the event loop that connects all these pieces together.</p>
              
            </div>

            
            <div class="flex-shrink-0 text-primary dark:text-blue-400 group-hover:text-secondary dark:group-hover:text-purple-400 transition-colors mt-1 md:order-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </a>
      
    </div>
  </div>
</nav>


        
        

        
        

        
        

<div class="comments-section mt-12 pt-8 border-t border-gray-200 dark:border-dark-border">
  <h3 class="text-xl sm:text-2xl font-bold mb-6 text-gray-900 dark:text-dark-text">Comments</h3>

  
  <div id="comments-placeholder" class="hidden">
    <div class="bg-gray-100 dark:bg-dark-bg border-2 border-dashed border-gray-300 dark:border-dark-border rounded-lg p-8 text-center">
      <svg class="w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
      <h4 class="text-lg font-semibold text-gray-900 dark:text-dark-text mb-2">
        Comments Require Consent
      </h4>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        The comment system (Giscus) uses GitHub and may set authentication cookies.
        Enable comments to join the discussion.
      </p>
      <button onclick="window.cookieConsent.enableComments()"
              class="px-6 py-2 bg-primary hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
        Enable Comments
      </button>
    </div>
  </div>

  
  <div id="giscus-wrapper" class="giscus-wrapper"></div>

  
  <script>
    (function() {
      'use strict';

      let giscusLoaded = false;
      let themeObserver = null;

      
      function loadGiscus() {
        if (giscusLoaded) return;

        const wrapper = document.getElementById('giscus-wrapper');
        const placeholder = document.getElementById('comments-placeholder');

        if (!wrapper) return;

        
        if (placeholder) placeholder.classList.add('hidden');
        wrapper.classList.remove('hidden');

        
        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.setAttribute('data-repo', 'rchaganti\/rchaganti.github.io');
        script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnkyNzcwNTE0Mjc=');
        script.setAttribute('data-category', 'Announcements');
        script.setAttribute('data-category-id', 'DIC_kwDOEIN4I84CS4rW');
        script.setAttribute('data-mapping', 'pathname');
        script.setAttribute('data-strict', '0');
        script.setAttribute('data-reactions-enabled', '1');
        script.setAttribute('data-emit-metadata', '0');
        script.setAttribute('data-input-position', 'bottom');
        script.setAttribute('data-theme', 'light');
        script.setAttribute('data-lang', 'en');
        script.setAttribute('data-loading', 'lazy');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;

        wrapper.appendChild(script);
        giscusLoaded = true;

        
        setupThemeObserver();
      }

      
      function updateGiscusTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        const theme = isDark ? 'dark' : 'light';

        const iframe = document.querySelector('iframe.giscus-frame');
        if (iframe) {
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            'https://giscus.app'
          );
        }
      }

      
      function setupThemeObserver() {
        if (themeObserver) return;

        
        themeObserver = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
              updateGiscusTheme();
            }
          });
        });

        themeObserver.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class']
        });

        
        window.addEventListener('message', function(event) {
          if (event.origin !== 'https://giscus.app') return;
          if (!(typeof event.data === 'object' && event.data.giscus)) return;

          
          if (event.data.giscus.discussion) {
            updateGiscusTheme();
          }
        });
      }

      
      function checkConsentAndLoad() {
        if (window.cookieConsent && window.cookieConsent.hasConsent('comments')) {
          loadGiscus();
        } else {
          
          const placeholder = document.getElementById('comments-placeholder');
          if (placeholder) placeholder.classList.remove('hidden');
        }
      }

      
      window.addEventListener('loadComments', loadGiscus);
      window.addEventListener('consentChanged', checkConsentAndLoad);

      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkConsentAndLoad);
      } else {
        checkConsentAndLoad();
      }
    })();
  </script>
</div>


      </div>
      

      
      <aside class="hidden lg:block relative">
        <div class="mb-6">
          
<div class="bg-white dark:bg-dark-bg-secondary rounded-xl shadow-md dark:shadow-lg dark:shadow-black/20 p-6 mb-6">
  <div class="flex items-center gap-3 mb-4">
    <div class="w-10 h-10 bg-[#0A66C2]/10 rounded-full flex items-center justify-center">
      <svg class="w-5 h-5 text-[#0A66C2]" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
      </svg>
    </div>
    <h3 class="font-semibold text-gray-900 dark:text-dark-text">Newsletter</h3>
  </div>
  <p class="text-sm text-gray-600 dark:text-dark-text-secondary mb-4">
    Get notified about new articles on cloud, AI, and infrastructure.
  </p>
  <a href="https://www.linkedin.com/build-relation/newsletter-follow?entityUrn=7418529089365520384" target="_blank"
    rel="noopener noreferrer"
    class="flex items-center justify-center gap-2 w-full px-4 py-2 bg-[#0A66C2] hover:bg-[#004182] !text-white text-sm font-semibold rounded-lg transition-colors no-underline">
    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
      <path
        d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
    </svg>
    Subscribe on LinkedIn
  </a>
</div>
        </div>
        <div class="mb-6">
          


  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
    <h3 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">
      You May Also Like
    </h3>
    <div>
      
        
<article class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0 last:mb-0 last:pb-0">
  <a href="https://ravichaganti.com/blog/google-adk-runner-and-execution-architecture/" class="no-underline block group">
    
    <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-1">
      Google ADK - Runner and execution architecture
    </h4>

    
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="2025-12-18">
      Dec 18, 2025
    </time>
  </a>
</article>

      
        
<article class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0 last:mb-0 last:pb-0">
  <a href="https://ravichaganti.com/blog/google-adk-sessions-state-and-memory/" class="no-underline block group">
    
    <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-1">
      Google ADK - Sessions, state, and memory
    </h4>

    
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="2025-12-05">
      Dec 5, 2025
    </time>
  </a>
</article>

      
        
<article class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0 last:mb-0 last:pb-0">
  <a href="https://ravichaganti.com/blog/google-adk-types-of-agents/" class="no-underline block group">
    
    <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-1">
      Google ADK - types of agents
    </h4>

    
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="2025-12-03">
      Dec 3, 2025
    </time>
  </a>
</article>

      
        
<article class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0 last:mb-0 last:pb-0">
  <a href="https://ravichaganti.com/blog/introduction-to-google-agent-development-kit/" class="no-underline block group">
    
    <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-1">
      Introduction to Google Agent Development Kit
    </h4>

    
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="2025-12-01">
      Dec 1, 2025
    </time>
  </a>
</article>

      
        
<article class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-700 last:border-b-0 last:mb-0 last:pb-0">
  <a href="https://ravichaganti.com/blog/building-multi-agent-systems-with-google-adk-and-the-a2a-protocol/" class="no-underline block group">
    
    <h4 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors line-clamp-2 mb-1">
      Building multi-agent systems with Google ADK and the A2A protocol
    </h4>

    
    <time class="text-xs text-gray-500 dark:text-gray-400" datetime="2026-01-27">
      Jan 27, 2026
    </time>
  </a>
</article>

      
    </div>
  </div>


        </div>
        <div class="sidebar-sticky-reinforced">
          


<div class="bg-white dark:bg-dark-bg-secondary rounded-xl shadow-md dark:shadow-lg dark:shadow-black/20 p-6 mb-6">
  <h3 class="font-semibold text-gray-900 dark:text-dark-text mb-4 flex items-center">
    <svg class="w-5 h-5 mr-2 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
    </svg>
    Table of Contents
  </h3>

  <nav id="sidebar-toc" class="toc-sidebar text-sm max-h-[calc(100vh-200px)] overflow-y-auto custom-scrollbar">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#callbacks">Callbacks</a>
      <ul>
        <li><a href="#agent-lifecycle-callbacks">Agent lifecycle callbacks</a></li>
        <li><a href="#model-interaction-callbacks">Model interaction callbacks</a></li>
        <li><a href="#tool-execution-callbacks">Tool execution callbacks</a></li>
        <li><a href="#callbackcontext">CallbackContext</a></li>
        <li><a href="#toolcontext">ToolContext</a></li>
        <li><a href="#state-prefixes-in-callbacks">State prefixes in callbacks</a></li>
        <li><a href="#registering-callbacks">Registering callbacks</a></li>
      </ul>
    </li>
    <li><a href="#observability-logging">Observability logging</a></li>
    <li><a href="#input-guardrails">Input guardrails</a></li>
    <li><a href="#output-sanitization">Output sanitization</a></li>
    <li><a href="#tool-authorization">Tool authorization</a></li>
    <li><a href="#response-caching">Response caching</a></li>
    <li><a href="#dynamic-instruction-injection">Dynamic instruction injection</a></li>
    <li><a href="#artifact-handling-in-callbacks">Artifact handling in callbacks</a></li>
    <li><a href="#putting-it-all-together">Putting it all together</a></li>
  </ul>
</nav>
  </nav>
</div>

<style>
  #sidebar-toc ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
  }

  #sidebar-toc ul ul {
    padding-left: 1rem;
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
    border-left: 1px solid #e5e7eb;
     
  }

  .dark #sidebar-toc ul ul {
    border-color: #374151;
     
  }

  #sidebar-toc li {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  #sidebar-toc a {
    display: block;
    color: #4b5563;
     
    text-decoration: none;
    transition: all 0.2s;
    padding-left: 0.5rem;
    border-left: 2px solid transparent;
    margin-left: -1px;
     
  }

  #sidebar-toc a:hover {
    color: #1e40af;
     
    text-decoration: none;
  }

   
  #sidebar-toc a.active {
    color: #2563eb;
     
    font-weight: 600;
    border-left-color: #2563eb;
  }

   
  .dark #sidebar-toc a {
    color: #9ca3af;
     
  }

  .dark #sidebar-toc a:hover {
    color: #60a5fa;
     
  }

  .dark #sidebar-toc a.active {
    color: #60a5fa;
     
    border-left-color: #60a5fa;
  }

   
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #e5e7eb;
    border-radius: 20px;
  }

  .dark .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: #374151;
  }
</style>


        </div>
      </aside>
    </div>
    
  </div>

  
  <script src="/js/collapse.js"></script>
  <script src="/js/code-copy.js"></script>
  <script src="/js/toc-scrollspy.js"></script>
</article>

  </main>

  <footer class="bg-gray-900 dark:bg-dark-bg text-gray-300 dark:text-dark-text-secondary mt-16">
  <div class="container mx-auto px-4 py-8">
    <div class="text-center text-sm">
      <p>&copy; 2026 Ravikanth Chaganti. All rights reserved.</p>
    </div>
  </div>
</footer>


  
  <button id="back-to-top"
          class="fixed bottom-8 right-8 w-12 h-12 bg-primary text-white rounded-full shadow-lg hover:bg-blue-700 transition-all opacity-0 pointer-events-none z-40"
          aria-label="Back to top"
          title="Back to top">
    <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
  </button>

  
  

  
  <script>
    
    
    
  </script>

  
  
    <script src="/js/reading-progress.js"></script>
  

  
  <script src="/js/back-to-top.js"></script>

  
  <script src="/js/theme-toggle.js"></script>

  
  <script src="/js/cookie-consent.js"></script>

  
  

  
  <script
    data-goatcounter="https://ravichaganti.goatcounter.com/count"
    async
    src="//gc.zgo.at/count.js">
  </script>



  
  
<div id="cookie-consent-banner"
     class="hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg z-50 transition-transform duration-300">
  <div class="container mx-auto px-4 py-2">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-4">

      
      <div class="flex-1">
        <p class="text-xs sm:text-sm text-gray-700 dark:text-gray-200">
          This site may load third-party content (comments, embeds) that could set cookies.
          <a href="#"
             id="cookie-learn-more"
             class="text-primary hover:underline font-medium ml-1"
             onclick="document.getElementById('cookie-customize').click(); return false;">
            Learn more
          </a>
        </p>
      </div>

      
      <div class="flex flex-row gap-2 w-full sm:w-auto flex-shrink-0">
        <button id="cookie-reject-all"
                class="px-3 py-1 text-xs font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors">
          Reject
        </button>
        <button id="cookie-customize"
                class="px-3 py-1 text-xs font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors">
          Settings
        </button>
        <button id="cookie-accept-all"
                class="px-3 py-1 text-xs font-medium text-white bg-primary hover:bg-blue-700 rounded transition-colors">
          Accept
        </button>
      </div>
    </div>
  </div>
</div>


<div id="cookie-settings-modal"
     class="hidden fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 flex items-center justify-center p-4 overflow-y-auto">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl my-8">

    
    <div class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 py-3 rounded-t-lg">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold text-gray-900 dark:text-gray-100">
          Cookie Preferences
        </h2>
        <button id="cookie-modal-close"
                class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors"
                aria-label="Close">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    
    <div class="px-6 py-4 space-y-4 max-h-[calc(90vh-140px)] overflow-y-auto bg-white dark:bg-gray-800">

      
      <div class="text-sm text-gray-600 dark:text-gray-300">
        <p>
          Control what third-party content is loaded. We use privacy-friendly analytics with no cookies.
        </p>
      </div>

      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

        
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-900">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
              Essential
            </h3>
            <div class="flex items-center justify-center w-10 h-5 bg-primary rounded-full flex-shrink-0">
              <span class="text-xs font-medium text-white">ON</span>
            </div>
          </div>
          <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">
            Required for the website to function. Cannot be disabled.
          </p>
          <ul class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
            <li>• Theme preference</li>
            <li>• Privacy-friendly analytics</li>
          </ul>
        </div>

        
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-900">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
              Comments
            </h3>
            <label class="relative inline-block w-10 h-5 flex-shrink-0">
              <input type="checkbox"
                     id="consent-comments"
                     class="peer sr-only">
              <span class="absolute inset-0 bg-gray-300 dark:bg-gray-600 rounded-full cursor-pointer transition-colors peer-checked:bg-primary"></span>
              <span class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
            </label>
          </div>
          <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">
            Giscus comment system (GitHub Discussions).
          </p>
          <ul class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
            <li>• Authentication cookies</li>
            <li>• GitHub privacy policy</li>
          </ul>
        </div>

        
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-900">
          <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100">
              Embedded Content
            </h3>
            <label class="relative inline-block w-10 h-5 flex-shrink-0">
              <input type="checkbox"
                     id="consent-embeds"
                     class="peer sr-only">
              <span class="absolute inset-0 bg-gray-300 dark:bg-gray-600 rounded-full cursor-pointer transition-colors peer-checked:bg-primary"></span>
              <span class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-5"></span>
            </label>
          </div>
          <p class="text-xs text-gray-600 dark:text-gray-300 mb-2">
            Videos, code snippets, presentations.
          </p>
          <ul class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
            <li>• YouTube, Gists, SlideShare</li>
            <li>• May set tracking cookies</li>
          </ul>
        </div>
      </div>

      
      <div class="bg-blue-50 dark:bg-blue-950 dark:bg-opacity-50 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
          </svg>
          <div class="text-sm">
            <p class="font-semibold mb-1 text-blue-800 dark:text-blue-200">Privacy First</p>
            <p class="text-xs text-gray-700 dark:text-gray-300">
              No tracking cookies. Third-party content only loads with your consent. Preferences stored locally in your browser.
            </p>
          </div>
        </div>
      </div>
    </div>

    
    <div class="bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 px-4 py-3 rounded-b-lg">
      <div class="flex justify-end">
        <button id="cookie-save-preferences"
                class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-blue-700 dark:hover:bg-blue-600 rounded transition-colors shadow-sm">
          Save Preferences
        </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
